# ===================================================================
# Spring Boot + Synology PR Preview ì‹œìŠ¤í…œ
# ===================================================================
#
# PR ì½”ë©˜íŠ¸ ëª…ë ¹ì–´ë¥¼ í†µí•´ Preview í™˜ê²½ì„ ìë™ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
# Traefik ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ í†µí•´ ë™ì  ë¼ìš°íŒ…ë©ë‹ˆë‹¤.
#
# ğŸš€ ì‚¬ìš©ë²•:
#   @suh-lab pr build    - PR ë¹Œë“œ ë° ë°°í¬ (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìë™ êµì²´)
#   @suh-lab pr destroy  - Preview í™˜ê²½ ì‚­ì œ
#   @suh-lab pr status   - í˜„ì¬ ìƒíƒœ í™•ì¸
#
# âš™ï¸ í”„ë¡œì íŠ¸ë³„ í•„ìˆ˜ ìˆ˜ì • ì‚¬í•­:
#   ì•„ë˜ env ì„¹ì…˜ì˜ ê°’ë“¤ì„ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
#
# ğŸ”‘ GitHub Secrets:
#
#   [í•„ìˆ˜] ëª¨ë“  í”„ë¡œì íŠ¸ ê³µí†µ:
#   - APPLICATION_PROD_YML: Spring application-prod.yml ì „ì²´ ë‚´ìš©
#   - DOCKERHUB_USERNAME: Docker Hub ì‚¬ìš©ìëª…
#   - DOCKERHUB_TOKEN: Docker Hub ì•¡ì„¸ìŠ¤ í† í°
#   - SERVER_HOST: ì‹œë†€ë¡œì§€ ì„œë²„ í˜¸ìŠ¤íŠ¸ (ì˜ˆ: suh-project.synology.me)
#   - SERVER_USER: SSH ì‚¬ìš©ìëª…
#   - SERVER_PASSWORD: SSH ë¹„ë°€ë²ˆí˜¸
#
#   [ì„ íƒ] í”„ë¡œì íŠ¸ë³„ ì¶”ê°€ (RomRom ì˜ˆì‹œ - í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ):
#   - VERTEX_SA_KEY: Vertex AI ì„œë¹„ìŠ¤ ê³„ì • í‚¤
#   - FIREBASE_KEY_JSON: Firebase Admin SDK í‚¤
#   - FIREBASE_MESSAGING_SW_JS: Firebase Messaging Service Worker
#   - PRICE_PREDICTION_PROMPT_YML: ê°€ê²© ì˜ˆì¸¡ í”„ë¡¬í”„íŠ¸
#   - ADMIN_YML: ê´€ë¦¬ì ì„¤ì •
#
# ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­:
#   - Traefik ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘ (traefik-network)
#   - ì™€ì¼ë“œì¹´ë“œ DNS ì„¤ì •: *.pr.suhsaechan.kr â†’ ì„œë²„
#   - ì„œë²„ì— í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¡´ì¬
#
#   â€» Health CheckëŠ” ìë™ìœ¼ë¡œ ìµœì  ë°©ì‹ ì„ íƒ (ì¶”ê°€ ì„¤ì • ë¶ˆí•„ìš”):
#     - Spring Actuator ìˆìœ¼ë©´ â†’ /actuator/health ì‚¬ìš©
#     - ì—†ìœ¼ë©´ â†’ ê¸°ë™ ë¡œê·¸ íŒ¨í„´ìœ¼ë¡œ í™•ì¸ ("Started ... in ... seconds")
#
# ğŸŒ Traefik ëŒ€ì‹œë³´ë“œ:
#   https://traefik.suhsaechan.kr/dashboard/#/
#
#   ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´:
#   - Entrypoints: íŠ¸ë˜í”½ ì§„ì…ì  (web:80, traefik:8080)
#   - HTTP Routers: PR Preview ë¼ìš°íŒ… ê·œì¹™ ëª©ë¡
#   - HTTP Services: ì—°ê²°ëœ ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ ëª©ë¡
#   - Middlewares: ì ìš©ëœ ë¯¸ë“¤ì›¨ì–´ (ì¸ì¦, ë¦¬ë‹¤ì´ë ‰íŠ¸ ë“±)
#   - Providers: Docker í”„ë¡œë°”ì´ë” ìƒíƒœ
#
#   ë°°í¬ í›„ ëŒ€ì‹œë³´ë“œì—ì„œ ìƒˆë¡œìš´ Router/Serviceê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#   ì˜ˆ: Router "romrom-pr-123" â†’ Service "romrom-pr-123"
#
# ğŸ“Š ë¦¬ì†ŒìŠ¤ ë„¤ì´ë° ê·œì¹™:
#   - ì»¨í…Œì´ë„ˆ: {PROJECT_NAME}-pr-{PRë²ˆí˜¸}
#   - ì´ë¯¸ì§€: {DOCKERHUB_USERNAME}/{PROJECT_NAME}:pr-{PRë²ˆí˜¸}
#   - ë„ë©”ì¸: {PROJECT_NAME}-pr-{PRë²ˆí˜¸}.pr.suhsaechan.kr
#   - Preview URL: http://{ë„ë©”ì¸}:8079
#
# ===================================================================

name: PROJECT-SPRING-SYNOLOGY-PR-PREVIEW

# ===================================================================
# âš ï¸ í”„ë¡œì íŠ¸ë³„ ì„¤ì • - ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì‹œ ì´ ì„¹ì…˜ë§Œ ìˆ˜ì •í•˜ì„¸ìš”
# ===================================================================
env:
  # í”„ë¡œì íŠ¸ ê³ ìœ  ì‹ë³„ì (ì»¨í…Œì´ë„ˆëª…, ì´ë¯¸ì§€ëª…, ë„ë©”ì¸ì— ì‚¬ìš©)(í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  PROJECT_NAME: romrom

  # Spring Boot ë¹Œë“œ ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  JAVA_VERSION: '17'
  GRADLE_BUILD_CMD: './gradlew clean build -x test -Dspring.profiles.active=prod'
  JAR_PATH: 'RomRom-Web/build/libs/*.jar'
  APPLICATION_YML_PATH: 'RomRom-Web/src/main/resources/application-prod.yml'

  # Docker ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  DOCKERFILE_PATH: './Dockerfile'
  INTERNAL_PORT: '8080'

  # Traefik & Preview ë„ë©”ì¸ ì„¤ì • (í™˜ê²½ êµ¬ì¶• í›„ ìˆ˜ì • ê¸ˆì§€) 
  TRAEFIK_NETWORK: traefik-network
  PREVIEW_DOMAIN_SUFFIX: pr.suhsaechan.kr
  PREVIEW_PORT: '8079'

  # SSH í¬íŠ¸ (ì‹œë†€ë¡œì§€ í¬íŠ¸ í™˜ê²½ êµ¬ì¶• í›„ ìˆ˜ì • ê¸ˆì§€)
  SSH_PORT: '2022'

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: write
  issues: write

# ===================================================================
# Jobs
# ===================================================================
jobs:
  # -----------------------------------------------------------------
  # Job 1: ëª…ë ¹ì–´ íŒŒì‹±
  # -----------------------------------------------------------------
  check-command:
    name: ëª…ë ¹ì–´ í™•ì¸
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
    steps:
      - name: ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€
        if: contains(github.event.comment.body, '@suh-lab') && contains(github.event.comment.body, 'pr')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: ì»¤ë§¨ë“œ íŒŒì‹±
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"

          if [[ "$COMMENT" =~ @suh-lab[[:space:]]+pr[[:space:]]+build ]]; then
            echo "command=build" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… ëª…ë ¹ì–´ ê°ì§€: build"
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+pr[[:space:]]+destroy ]]; then
            echo "command=destroy" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… ëª…ë ¹ì–´ ê°ì§€: destroy"
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+pr[[:space:]]+status ]]; then
            echo "command=status" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… ëª…ë ¹ì–´ ê°ì§€: status"
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ @suh-lab pr ëª…ë ¹ì–´ê°€ ì•„ë‹˜"
          fi

  # -----------------------------------------------------------------
  # Job 2: ë¹Œë“œ & ë°°í¬
  # -----------------------------------------------------------------
  build-preview:
    name: Preview ë¹Œë“œ & ë°°í¬
    needs: check-command
    if: needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'build'
    runs-on: ubuntu-latest
    steps:
      - name: PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha.substring(0, 7));
            return pr.data.number;

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref }}

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x gradlew

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„±
      # =================================================================
      #
      # ğŸ“‹ í•„ìˆ˜ (ëª¨ë“  Spring Boot í”„ë¡œì íŠ¸):
      #   - application-prod.yml
      #
      # ğŸ“‹ ì„ íƒ (í”„ë¡œì íŠ¸ì— ë”°ë¼ ì¶”ê°€/ì œê±°):
      #   - Firebase: firebase-admin-sdk.json, firebase-messaging-sw.js
      #   - Vertex AI: gen-lang-client-xxx.json
      #   - ê¸°íƒ€ ì„¤ì • íŒŒì¼: admin.yml, price-prediction.prompt.yml ë“±
      #
      # âš ï¸ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì‹œ:
      #   1. í•„ìš” ì—†ëŠ” stepì€ ì‚­ì œí•˜ì„¸ìš”
      #   2. í•„ìš”í•œ stepì„ ì¶”ê°€í•˜ì„¸ìš”
      #   3. íŒŒì¼ ê²½ë¡œë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”
      # =================================================================

      # [í•„ìˆ˜] Spring Boot ì„¤ì • íŒŒì¼
      - name: "[í•„ìˆ˜] application-prod.yml ìƒì„±"
        run: |
          mkdir -p RomRom-Web/src/main/resources
          cat << 'EOF' > ${{ env.APPLICATION_YML_PATH }}
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF

      # [ì„ íƒ] Vertex AI - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Vertex AI Service Account Key ìƒì„±"
        env:
          VERTEX_SA_KEY: ${{ secrets.VERTEX_SA_KEY }}
        run: |
          echo "$VERTEX_SA_KEY" | sed 's/\\n/\n/g' > ./RomRom-Web/src/main/resources/gen-lang-client-0511951522-e0dc1d68cbcb.json

      # [ì„ íƒ] Firebase - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Firebase Admin SDK ìƒì„±"
        env:
          FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          echo "$FIREBASE_KEY_JSON" | sed 's/\\n/\n/g' > ./RomRom-Web/src/main/resources/firebase-admin-sdk.json

      # [ì„ íƒ] Firebase - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Firebase Messaging SW ìƒì„±"
        run: |
          mkdir -p RomRom-Web/src/main/resources/static
          cat << 'EOF' > ./RomRom-Web/src/main/resources/static/firebase-messaging-sw.js
          ${{ secrets.FIREBASE_MESSAGING_SW_JS }}
          EOF

      # [ì„ íƒ] AI í”„ë¡¬í”„íŠ¸ - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] price-prediction.prompt.yml ìƒì„±"
        run: |
          cat << 'EOF' > ./RomRom-Web/src/main/resources/price-prediction.prompt.yml
          ${{ secrets.PRICE_PREDICTION_PROMPT_YML }}
          EOF

      # [ì„ íƒ] ê´€ë¦¬ì ì„¤ì • - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] admin.yml ìƒì„±"
        run: |
          cat << 'EOF' > ./RomRom-Web/src/main/resources/admin.yml
          ${{ secrets.ADMIN_YML }}
          EOF

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2 ë] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„± ë
      # =================================================================

      - name: Gradle ë¹Œë“œ
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ github.event.issue.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # ë³€ìˆ˜ ì„¤ì •
            PR_NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${PR_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ PR Preview ë°°í¬ ì‹œì‘"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ PR ë²ˆí˜¸: #${PR_NUMBER}"
            echo "ğŸ“› ì»¨í…Œì´ë„ˆ: ${CONTAINER_NAME}"
            echo "ğŸŒ ë„ë©”ì¸: ${DOMAIN}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸ³ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              -v /etc/localtime:/etc/localtime:ro \
              "${IMAGE}"

            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # Health Check (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°) - í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
            # 1. Actuator ìˆìœ¼ë©´ â†’ /actuator/health ì‚¬ìš©
            # 2. ì—†ìœ¼ë©´ â†’ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ ("Started ... in ... seconds")
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            echo ""
            echo "â³ Health Check ì‹œì‘ (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°)..."
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "âŒ ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ!"
                echo ""
                echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. Actuator Health Check ì‹œë„ (wget ì‚¬ìš© - alpine ê¸°ë³¸ í¬í•¨)
                HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- http://localhost:${INTERNAL_PORT}/actuator/health 2>/dev/null || echo "")

                if echo "$HEALTH" | grep -q '"status":"UP"'; then
                  echo "âœ… Spring Boot ì •ìƒ ê¸°ë™ í™•ì¸! (Actuator)"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Actuator"
                  break
                fi

                # 3. Actuator ì—†ìœ¼ë©´ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ í´ë°±
                STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "Started .* in [0-9.]+ seconds" || echo "")

                if [ -n "$STARTED" ]; then
                  echo "âœ… Spring Boot ì •ìƒ ê¸°ë™ í™•ì¸! (ë¡œê·¸ íŒ¨í„´)"
                  echo "   $STARTED"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Log"
                  break
                fi
              fi

              echo "â³ ëŒ€ê¸° ì¤‘... ($RETRY_COUNT/$MAX_RETRIES) - ìƒíƒœ: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "âŒ Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ)"
              echo ""
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ë°°í¬ ë° Health Check ì™„ë£Œ! (ë°©ì‹: ${HEALTH_CHECK_METHOD})"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ë°°í¬ ì™„ë£Œ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const domain = `${projectName}-pr-${prNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const sha = '${{ steps.pr.outputs.sha }}';

            const body = [
              '## ğŸš€ Preview ë°°í¬ ì™„ë£Œ!',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **Preview URL** | ${previewUrl} |`,
              `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${prNumber}\` |`,
              `| **ì»¤ë°‹** | \`${sha}\` |`,
              '',
              '### ğŸ“‹ ëª…ë ¹ì–´',
              '| ëª…ë ¹ì–´ | ì„¤ëª… |',
              '|--------|------|',
              '| `@suh-lab pr build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
              '| `@suh-lab pr destroy` | Preview í™˜ê²½ ì‚­ì œ |',
              '| `@suh-lab pr status` | í˜„ì¬ ìƒíƒœ í™•ì¸ |',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## âŒ Preview ë°°í¬ ì‹¤íŒ¨!',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **í”„ë¡œì íŠ¸** | ${projectName} |`,
              `| **PR** | #${prNumber} |`,
              '',
              `**[ğŸ“‹ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ í™•ì¸](${runUrl})**`,
              '',
              '### ğŸ” ê°€ëŠ¥í•œ ì›ì¸',
              '- Gradle ë¹Œë“œ ì‹¤íŒ¨',
              '- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨',
              '- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ (Spring Boot ê¸°ë™ ì˜¤ë¥˜)',
              '- Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ ë‚´ ê¸°ë™ ì™„ë£Œ ì•ˆë¨)',
              '',
              '### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„',
              '1. ìœ„ ë§í¬ì—ì„œ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”',
              '2. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”: `@suh-lab pr build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 3: Preview ì‚­ì œ
  # -----------------------------------------------------------------
  destroy-preview:
    name: Preview ì‚­ì œ
    needs: check-command
    if: |
      (github.event_name == 'issue_comment' && needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'destroy') ||
      (github.event_name == 'pull_request' && github.event.action == 'closed')
    runs-on: ubuntu-latest
    steps:
      - name: PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        id: pr_number
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: ì»¨í…Œì´ë„ˆ & ì´ë¯¸ì§€ ì‚­ì œ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            PR_NUMBER=${{ steps.pr_number.outputs.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ—‘ï¸ PR Preview ì‚­ì œ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ PR ë²ˆí˜¸: #${PR_NUMBER}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ³ ì»¨í…Œì´ë„ˆ ì‚­ì œ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ì´ë¯¸ì§€ ì‚­ì œ
            echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            echo $PW | sudo -S docker rmi "${IMAGE}" 2>/dev/null || true

            echo "âœ… ì‚­ì œ ì™„ë£Œ!"

      - name: ì‚­ì œ ì™„ë£Œ ì½”ë©˜íŠ¸
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';

            const body = [
              '## ğŸ—‘ï¸ Preview í™˜ê²½ ì‚­ì œ ì™„ë£Œ!',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${prNumber}\` |`,
              '| **ìƒíƒœ** | ì‚­ì œë¨ |',
              '',
              'ë‹¤ì‹œ ë°°í¬í•˜ë ¤ë©´: `@suh-lab pr build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 4: ìƒíƒœ í™•ì¸
  # -----------------------------------------------------------------
  check-status:
    name: Preview ìƒíƒœ í™•ì¸
    needs: check-command
    if: needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'status'
    runs-on: ubuntu-latest
    steps:
      - name: ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        id: status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin

            PR_NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” PR Preview ìƒíƒœ í™•ì¸"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "STATUS=running"
              echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
              docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"
            else
              echo "STATUS=not_found"
              echo "âŒ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ (ì‹¤í–‰ ì¤‘)
        uses: appleboy/ssh-action@v1.0.3
        id: check_running
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin

            PR_NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ ì‘ì„±
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const domain = `${projectName}-pr-${prNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const isRunning = '${{ steps.check_running.outcome }}' === 'success';

            let body;
            if (isRunning) {
              body = [
                '## âœ… Preview í™˜ê²½ ì‹¤í–‰ ì¤‘',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **Preview URL** | ${previewUrl} |`,
                `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${prNumber}\` |`,
                '| **ìƒíƒœ** | ğŸŸ¢ Running |',
                '',
                '### ğŸ“‹ ëª…ë ¹ì–´',
                '| ëª…ë ¹ì–´ | ì„¤ëª… |',
                '|--------|------|',
                '| `@suh-lab pr build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
                '| `@suh-lab pr destroy` | Preview í™˜ê²½ ì‚­ì œ |',
                '',
                '---',
                '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
              ].join('\n');
            } else {
              body = [
                '## âŒ Preview í™˜ê²½ ì—†ìŒ',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${prNumber}\` |`,
                '| **ìƒíƒœ** | ğŸ”´ Not Found |',
                '',
                'ë°°í¬í•˜ë ¤ë©´: `@suh-lab pr build`',
                '',
                '---',
                '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
              ].join('\n');
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
