# ===================================================================
# Spring Boot + Synology PR/Issue Preview ì‹œìŠ¤í…œ
# ===================================================================
#
# PR ë˜ëŠ” Issue ì½”ë©˜íŠ¸ ëª…ë ¹ì–´ë¥¼ í†µí•´ Preview í™˜ê²½ì„ ìë™ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
# Traefik ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ í†µí•´ ë™ì  ë¼ìš°íŒ…ë©ë‹ˆë‹¤.
#
# ğŸš€ ì‚¬ìš©ë²•:
#   @suh-lab test build    - PR/Issue ë¹Œë“œ ë° ë°°í¬ (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìë™ êµì²´)
#   @suh-lab test destroy  - Preview í™˜ê²½ ì‚­ì œ
#   @suh-lab test status   - í˜„ì¬ ìƒíƒœ í™•ì¸
#
# ğŸ“Œ Issueì—ì„œ ë¹Œë“œ ì‹œ:
#   - Issue Helper ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ëª…ì„ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.
#   - ISSUE_HELPER_MARKER í™˜ê²½ë³€ìˆ˜ë¡œ ë§ˆì»¤ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#
# âš™ï¸ í”„ë¡œì íŠ¸ë³„ í•„ìˆ˜ ìˆ˜ì • ì‚¬í•­:
#   ì•„ë˜ env ì„¹ì…˜ì˜ ê°’ë“¤ì„ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
#
# ğŸ”‘ GitHub Secrets:
#
#   [í•„ìˆ˜] ëª¨ë“  í”„ë¡œì íŠ¸ ê³µí†µ:
#   - APPLICATION_PROD_YML: Spring application-prod.yml ì „ì²´ ë‚´ìš©
#   - DOCKERHUB_USERNAME: Docker Hub ì‚¬ìš©ìëª…
#   - DOCKERHUB_TOKEN: Docker Hub ì•¡ì„¸ìŠ¤ í† í°
#   - SERVER_HOST: ì‹œë†€ë¡œì§€ ì„œë²„ í˜¸ìŠ¤íŠ¸ (ì˜ˆ: suh-project.synology.me)
#   - SERVER_USER: SSH ì‚¬ìš©ìëª…
#   - SERVER_PASSWORD: SSH ë¹„ë°€ë²ˆí˜¸
#
#   [ì„ íƒ] í”„ë¡œì íŠ¸ë³„ ì¶”ê°€ (RomRom ì˜ˆì‹œ - í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ):
#   - VERTEX_SA_KEY: Vertex AI ì„œë¹„ìŠ¤ ê³„ì • í‚¤
#   - FIREBASE_KEY_JSON: Firebase Admin SDK í‚¤
#   - FIREBASE_MESSAGING_SW_JS: Firebase Messaging Service Worker
#   - PRICE_PREDICTION_PROMPT_YML: ê°€ê²© ì˜ˆì¸¡ í”„ë¡¬í”„íŠ¸
#   - ADMIN_YML: ê´€ë¦¬ì ì„¤ì •
#
# ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­:
#   - Traefik ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘ (traefik-network)
#   - ì™€ì¼ë“œì¹´ë“œ DNS ì„¤ì •: *.pr.suhsaechan.kr â†’ ì„œë²„
#   - ì„œë²„ì— í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¡´ì¬
#
#   â€» Health CheckëŠ” ìë™ìœ¼ë¡œ ìµœì  ë°©ì‹ ì„ íƒ (ì¶”ê°€ ì„¤ì • ë¶ˆí•„ìš”):
#     - Spring Actuator ìˆìœ¼ë©´ â†’ /actuator/health ì‚¬ìš©
#     - ì—†ìœ¼ë©´ â†’ ê¸°ë™ ë¡œê·¸ íŒ¨í„´ìœ¼ë¡œ í™•ì¸ ("Started ... in ... seconds")
#
# ğŸŒ Traefik ëŒ€ì‹œë³´ë“œ:
#   https://traefik.suhsaechan.kr/dashboard/#/
#
#   ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´:
#   - Entrypoints: íŠ¸ë˜í”½ ì§„ì…ì  (web:80, traefik:8080)
#   - HTTP Routers: PR Preview ë¼ìš°íŒ… ê·œì¹™ ëª©ë¡
#   - HTTP Services: ì—°ê²°ëœ ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ ëª©ë¡
#   - Middlewares: ì ìš©ëœ ë¯¸ë“¤ì›¨ì–´ (ì¸ì¦, ë¦¬ë‹¤ì´ë ‰íŠ¸ ë“±)
#   - Providers: Docker í”„ë¡œë°”ì´ë” ìƒíƒœ
#
#   ë°°í¬ í›„ ëŒ€ì‹œë³´ë“œì—ì„œ ìƒˆë¡œìš´ Router/Serviceê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#   ì˜ˆ: Router "romrom-pr-123" â†’ Service "romrom-pr-123"
#
# ğŸ“Š ë¦¬ì†ŒìŠ¤ ë„¤ì´ë° ê·œì¹™:
#   - ì»¨í…Œì´ë„ˆ: {PROJECT_NAME}-pr-{PR/Issueë²ˆí˜¸}
#   - ì´ë¯¸ì§€: {DOCKERHUB_USERNAME}/{PROJECT_NAME}:pr-{PR/Issueë²ˆí˜¸}
#   - ë„ë©”ì¸: {PROJECT_NAME}-pr-{PR/Issueë²ˆí˜¸}.pr.suhsaechan.kr
#   - Preview URL: http://{ë„ë©”ì¸}:8079
#
# ğŸ“ Issue Helper ë§ˆì»¤ ì˜ˆì‹œ:
#   - RomRom: 'Chuseok22 issue helper'
#   - ë‹¤ë¥¸ í”„ë¡œì íŠ¸: 'SUH-ISSUE-HELPER'
#
# ===================================================================

name: PROJECT-SPRING-SYNOLOGY-PR-PREVIEW

# ===================================================================
# âš ï¸ í”„ë¡œì íŠ¸ë³„ ì„¤ì • - ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì‹œ ì´ ì„¹ì…˜ë§Œ ìˆ˜ì •í•˜ì„¸ìš”
# ===================================================================
env:
  # í”„ë¡œì íŠ¸ ê³ ìœ  ì‹ë³„ì (ì»¨í…Œì´ë„ˆëª…, ì´ë¯¸ì§€ëª…, ë„ë©”ì¸ì— ì‚¬ìš©)(í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  PROJECT_NAME: romrom

  # Spring Boot ë¹Œë“œ ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  JAVA_VERSION: '17'
  GRADLE_BUILD_CMD: './gradlew clean build -x test -Dspring.profiles.active=prod'
  JAR_PATH: 'RomRom-Web/build/libs/*.jar'
  APPLICATION_YML_PATH: 'RomRom-Web/src/main/resources/application-prod.yml'

  # Docker ì„¤ì • (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  DOCKERFILE_PATH: './Dockerfile'
  INTERNAL_PORT: '8080'

  # Traefik & Preview ë„ë©”ì¸ ì„¤ì • (í™˜ê²½ êµ¬ì¶• í›„ ìˆ˜ì • ê¸ˆì§€) 
  TRAEFIK_NETWORK: traefik-network
  PREVIEW_DOMAIN_SUFFIX: pr.suhsaechan.kr
  PREVIEW_PORT: '8079'

  # SSH í¬íŠ¸ (ì‹œë†€ë¡œì§€ í¬íŠ¸ í™˜ê²½ êµ¬ì¶• í›„ ìˆ˜ì • ê¸ˆì§€)
  SSH_PORT: '2022'

  # Issue Helper ëŒ“ê¸€ ë§ˆì»¤ (í”„ë¡œì íŠ¸ë³„ ìˆ˜ì • í•„ìš”)
  # Issue ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ëª…ì„ ì¶”ì¶œí•  ë•Œ ì‚¬ìš©
  ISSUE_HELPER_MARKER: 'Chuseok22 issue helper'

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  issue_comment:
    types: [created]      # PR ëŒ“ê¸€ + Issue ëŒ“ê¸€
  issues:
    types: [closed]       # Issue ë‹«í˜ ì‹œ destroy
  pull_request:
    types: [closed]       # PR ë‹«í˜ ì‹œ destroy

permissions:
  contents: read
  pull-requests: write
  issues: write

# ===================================================================
# Jobs
# ===================================================================
jobs:
  # -----------------------------------------------------------------
  # Job 1: ëª…ë ¹ì–´ íŒŒì‹± (PR ëŒ“ê¸€ + Issue ëŒ“ê¸€ ëª¨ë‘ ì§€ì›)
  # -----------------------------------------------------------------
  check-command:
    name: ëª…ë ¹ì–´ í™•ì¸
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      is_valid: ${{ steps.parse.outputs.is_valid }}
      is_pr: ${{ steps.parse.outputs.is_pr }}
    steps:
      - name: ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€
        if: contains(github.event.comment.body, '@suh-lab') && contains(github.event.comment.body, 'test')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: ì»¤ë§¨ë“œ íŒŒì‹±
        id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
          IS_PR: ${{ github.event.issue.pull_request }}
        run: |
          # PRì¸ì§€ Issueì¸ì§€ í™•ì¸
          if [[ "$IS_PR" != "" ]]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ PR ëŒ“ê¸€ì—ì„œ ëª…ë ¹ì–´ ê°ì§€"
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Issue ëŒ“ê¸€ì—ì„œ ëª…ë ¹ì–´ ê°ì§€"
          fi

          # COMMENT ì „ë‹¬
          if [[ "$COMMENT" =~ @suh-lab[[:space:]]+test[[:space:]]+build ]]; then
            echo "command=build" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… ëª…ë ¹ì–´ ê°ì§€: build"
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+test[[:space:]]+destroy ]]; then
            echo "command=destroy" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… ëª…ë ¹ì–´ ê°ì§€: destroy"
          elif [[ "$COMMENT" =~ @suh-lab[[:space:]]+test[[:space:]]+status ]]; then
            echo "command=status" >> $GITHUB_OUTPUT
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… ëª…ë ¹ì–´ ê°ì§€: status"
          else
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ @suh-lab test ëª…ë ¹ì–´ê°€ ì•„ë‹˜"
          fi

  # -----------------------------------------------------------------
  # Job 2: Issueì—ì„œ ë¸Œëœì¹˜ëª… ì¶”ì¶œ
  # -----------------------------------------------------------------
  get-branch-from-issue:
    name: Issueì—ì„œ ë¸Œëœì¹˜ ì¶”ì¶œ
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.is_pr == 'false'
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.extract.outputs.branch }}
      found: ${{ steps.extract.outputs.found }}
      issue_number: ${{ steps.extract.outputs.issue_number }}
    steps:
      - name: Issue ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ëª… ì¶”ì¶œ
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const marker = '${{ env.ISSUE_HELPER_MARKER }}';

            console.log(`ğŸ” Issue #${issueNumber}ì—ì„œ ë¸Œëœì¹˜ ê²€ìƒ‰ ì¤‘...`);
            console.log(`ğŸ“ ë§ˆì»¤: ${marker}`);

            // Issueì˜ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // ë¸Œëœì¹˜ ì¶”ì¶œ íŒ¨í„´ (ë§ˆì»¤ì™€ ë¬´ê´€í•˜ê²Œ ë™ì¼í•œ í˜•ì‹)
            // "### ë¸Œëœì¹˜" ë˜ëŠ” "### ë¸Œëœì¹˜ëª…" ë‘˜ ë‹¤ ë§¤ì¹­
            const branchRegex = /###\s*ë¸Œëœì¹˜(?:ëª…)?\s*\n```\s*\n([^\n]+)\s*\n```/;

            for (const comment of comments.data) {
              // ë§ˆì»¤ê°€ í¬í•¨ëœ ëŒ“ê¸€ ì°¾ê¸°
              if (comment.body.includes(marker)) {
                const match = comment.body.match(branchRegex);
                if (match) {
                  const branchName = match[1].trim();
                  core.setOutput('branch', branchName);
                  core.setOutput('found', 'true');
                  core.setOutput('issue_number', issueNumber);
                  console.log(`âœ… ë¸Œëœì¹˜ ë°œê²¬: ${branchName}`);
                  return;
                }
              }
            }

            // ë¸Œëœì¹˜ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° - ì—ëŸ¬ê°€ ì•„ë‹˜, gracefulí•˜ê²Œ ì²˜ë¦¬
            core.setOutput('found', 'false');
            core.setOutput('issue_number', issueNumber);
            console.log('âš ï¸ Issue Helper ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      - name: ë¸Œëœì¹˜ ì—†ìŒ ì•Œë¦¼
        if: steps.extract.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const marker = '${{ env.ISSUE_HELPER_MARKER }}';

            const body = [
              '## âš ï¸ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **Issue** | #${issueNumber} |`,
              `| **ë§ˆì»¤** | \`${marker}\` |`,
              '',
              '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
              '1. Issue Helper ëŒ“ê¸€ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
              '2. ëŒ“ê¸€ì— `### ë¸Œëœì¹˜` ì„¹ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
              '3. `ISSUE_HELPER_MARKER` í™˜ê²½ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 3-1: ë¹Œë“œ & ë°°í¬ (PR ëŒ“ê¸€ì—ì„œ ì‹¤í–‰)
  # -----------------------------------------------------------------
  build-preview-pr:
    name: Preview ë¹Œë“œ & ë°°í¬ (PR)
    needs: check-command
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha.substring(0, 7));
            return pr.data.number;

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ì§„í–‰ ìƒí™© ëŒ“ê¸€ ì‹œìŠ¤í…œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const startTime = Date.now();

            const body = [
              '## ğŸš€ PR Preview ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref }}

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x gradlew

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„±
      # =================================================================
      #
      # ğŸ“‹ í•„ìˆ˜ (ëª¨ë“  Spring Boot í”„ë¡œì íŠ¸):
      #   - application-prod.yml
      #
      # ğŸ“‹ ì„ íƒ (í”„ë¡œì íŠ¸ì— ë”°ë¼ ì¶”ê°€/ì œê±°):
      #   - Firebase: firebase-admin-sdk.json, firebase-messaging-sw.js
      #   - Vertex AI: gen-lang-client-xxx.json
      #   - ê¸°íƒ€ ì„¤ì • íŒŒì¼: admin.yml, price-prediction.prompt.yml ë“±
      #
      # âš ï¸ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ì‹œ:
      #   1. í•„ìš” ì—†ëŠ” stepì€ ì‚­ì œí•˜ì„¸ìš”
      #   2. í•„ìš”í•œ stepì„ ì¶”ê°€í•˜ì„¸ìš”
      #   3. íŒŒì¼ ê²½ë¡œë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”
      # =================================================================

      # [í•„ìˆ˜] Spring Boot ì„¤ì • íŒŒì¼
      - name: "[í•„ìˆ˜] application-prod.yml ìƒì„±"
        run: |
          mkdir -p RomRom-Web/src/main/resources
          cat << 'EOF' > ${{ env.APPLICATION_YML_PATH }}
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF

      # [ì„ íƒ] Vertex AI - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Vertex AI Service Account Key ìƒì„±"
        env:
          VERTEX_SA_KEY: ${{ secrets.VERTEX_SA_KEY }}
        run: |
          echo "$VERTEX_SA_KEY" | sed 's/\\n/\n/g' > ./RomRom-Web/src/main/resources/gen-lang-client-0511951522-e0dc1d68cbcb.json

      # [ì„ íƒ] Firebase - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Firebase Admin SDK ìƒì„±"
        env:
          FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          echo "$FIREBASE_KEY_JSON" | sed 's/\\n/\n/g' > ./RomRom-Web/src/main/resources/firebase-admin-sdk.json

      # [ì„ íƒ] Firebase - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Firebase Messaging SW ìƒì„±"
        run: |
          mkdir -p RomRom-Web/src/main/resources/static
          cat << 'EOF' > ./RomRom-Web/src/main/resources/static/firebase-messaging-sw.js
          ${{ secrets.FIREBASE_MESSAGING_SW_JS }}
          EOF

      # [ì„ íƒ] AI í”„ë¡¬í”„íŠ¸ - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] price-prediction.prompt.yml ìƒì„±"
        run: |
          cat << 'EOF' > ./RomRom-Web/src/main/resources/price-prediction.prompt.yml
          ${{ secrets.PRICE_PREDICTION_PROMPT_YML }}
          EOF

      # [ì„ íƒ] ê´€ë¦¬ì ì„¤ì • - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] admin.yml ìƒì„±"
        run: |
          cat << 'EOF' > ./RomRom-Web/src/main/resources/admin.yml
          ${{ secrets.ADMIN_YML }}
          EOF

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2 ë] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„± ë
      # =================================================================

      - name: Gradle ë¹Œë“œ
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: ì§„í–‰ ìƒí™© - ë¹Œë“œ ì™„ë£Œ
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const startTime = ${{ steps.progress.outputs.start_time }};
            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const buildDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ PR Preview ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_start', now);

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ github.event.issue.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ì§„í–‰ ìƒí™© - Docker ì™„ë£Œ
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerStart = ${{ steps.build_progress.outputs.docker_start }};
            const now = Date.now();
            const dockerElapsed = now - dockerStart;
            const minutes = Math.floor(dockerElapsed / 60000);
            const seconds = Math.floor((dockerElapsed % 60000) / 1000);
            const dockerDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ PR Preview ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_duration', dockerDuration);
            core.setOutput('deploy_start', now);

      - name: ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # ë³€ìˆ˜ ì„¤ì •
            PR_NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${PR_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ PR Preview ë°°í¬ ì‹œì‘"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ PR ë²ˆí˜¸: #${PR_NUMBER}"
            echo "ğŸ“› ì»¨í…Œì´ë„ˆ: ${CONTAINER_NAME}"
            echo "ğŸŒ ë„ë©”ì¸: ${DOMAIN}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸ³ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              -v /etc/localtime:/etc/localtime:ro \
              "${IMAGE}"

            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # Health Check (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°) - í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
            # 1. Actuator ìˆìœ¼ë©´ â†’ /actuator/health ì‚¬ìš©
            # 2. ì—†ìœ¼ë©´ â†’ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ ("Started ... in ... seconds")
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            echo ""
            echo "â³ Health Check ì‹œì‘ (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°)..."
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "âŒ ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ!"
                echo ""
                echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. Actuator Health Check ì‹œë„ (wget ì‚¬ìš© - alpine ê¸°ë³¸ í¬í•¨)
                HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- http://localhost:${INTERNAL_PORT}/actuator/health 2>/dev/null || echo "")

                if echo "$HEALTH" | grep -q '"status":"UP"'; then
                  echo "âœ… Spring Boot ì •ìƒ ê¸°ë™ í™•ì¸! (Actuator)"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Actuator"
                  break
                fi

                # 3. Actuator ì—†ìœ¼ë©´ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ í´ë°±
                STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "Started .* in [0-9.]+ seconds" || echo "")

                if [ -n "$STARTED" ]; then
                  echo "âœ… Spring Boot ì •ìƒ ê¸°ë™ í™•ì¸! (ë¡œê·¸ íŒ¨í„´)"
                  echo "   $STARTED"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Log"
                  break
                fi
              fi

              echo "â³ ëŒ€ê¸° ì¤‘... ($RETRY_COUNT/$MAX_RETRIES) - ìƒíƒœ: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "âŒ Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ)"
              echo ""
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ë°°í¬ ë° Health Check ì™„ë£Œ! (ë°©ì‹: ${HEALTH_CHECK_METHOD})"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ë°°í¬ ì™„ë£Œ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const buildDuration = '${{ steps.docker_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployStart = ${{ steps.docker_progress.outputs.deploy_start }};
            const now = Date.now();
            const deployElapsed = now - deployStart;
            const minutes = Math.floor(deployElapsed / 60000);
            const seconds = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const prNumber = context.issue.number;
            const domain = `${projectName}-pr-${prNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const sha = '${{ steps.pr.outputs.sha }}';

            const body = [
              '## âœ… PR Preview ë°°í¬ ì™„ë£Œ!',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | âœ… ì™„ë£Œ | ${deployDuration} |`,
              '',
              '### ğŸŒ Preview í™˜ê²½',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **Preview URL** | ${previewUrl} |`,
              `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${prNumber}\` |`,
              `| **ì»¤ë°‹** | \`${sha}\` |`,
              '',
              '### ğŸ“‹ ëª…ë ¹ì–´',
              '| ëª…ë ¹ì–´ | ì„¤ëª… |',
              '|--------|------|',
              '| `@suh-lab test build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
              '| `@suh-lab test destroy` | Preview í™˜ê²½ ì‚­ì œ |',
              '| `@suh-lab test status` | í˜„ì¬ ìƒíƒœ í™•ì¸ |',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const prNumber = context.issue.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // ì§„í–‰ ìƒí™©ì— ë”°ë¼ ì–´ë””ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ í‘œì‹œ
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            // ì‹¤íŒ¨ ì§€ì  íŒë‹¨ - ì´ˆê¸° ë‹¨ê³„ ì‹¤íŒ¨ë„ êµ¬ë¶„
            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              // ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„± ì „ ì‹¤íŒ¨ (ì´ˆê¸°í™” ë‹¨ê³„)
              buildStatus = 'âš ï¸ ì´ˆê¸°í™” ì‹¤íŒ¨';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              // ë¹Œë“œ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨
              buildStatus = 'âŒ ì‹¤íŒ¨';
              dockerStatus = 'â¸ï¸ ëŒ€ê¸°';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
            } else if (!dockerDuration || dockerDuration === '') {
              // Docker ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âŒ ì‹¤íŒ¨';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
              buildTime = buildDuration;
            } else {
              // ë°°í¬ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âœ… ì™„ë£Œ';
              deployStatus = 'âŒ ì‹¤íŒ¨';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## âŒ PR Preview ë°°í¬ ì‹¤íŒ¨!',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | ${buildStatus} | ${buildTime} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | ${dockerStatus} | ${dockerTime} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | ${deployStatus} | - |`,
              '',
              `**[ğŸ“‹ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ í™•ì¸](${runUrl})**`,
              '',
              '### ğŸ” ê°€ëŠ¥í•œ ì›ì¸',
              '- Gradle ë¹Œë“œ ì‹¤íŒ¨',
              '- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨',
              '- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ (Spring Boot ê¸°ë™ ì˜¤ë¥˜)',
              '- Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ ë‚´ ê¸°ë™ ì™„ë£Œ ì•ˆë¨)',
              '',
              '### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„',
              '1. ìœ„ ë§í¬ì—ì„œ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”',
              '2. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”: `@suh-lab test build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            // ì§„í–‰ ìƒí™© ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  # -----------------------------------------------------------------
  # Job 3-2: ë¹Œë“œ & ë°°í¬ (Issue ëŒ“ê¸€ì—ì„œ ì‹¤í–‰)
  # -----------------------------------------------------------------
  build-preview-issue:
    name: Preview ë¹Œë“œ & ë°°í¬ (Issue)
    needs: [check-command, get-branch-from-issue]
    if: |
      needs.check-command.outputs.is_valid == 'true' &&
      needs.check-command.outputs.command == 'build' &&
      needs.check-command.outputs.is_pr == 'false' &&
      needs.get-branch-from-issue.outputs.found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ë¸Œëœì¹˜ ì¡´ì¬ í™•ì¸
        id: check_branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};

            console.log(`ğŸ” ë¸Œëœì¹˜ ì¡´ì¬ í™•ì¸: ${branchName}`);

            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              core.setOutput('exists', 'true');
              console.log(`âœ… ë¸Œëœì¹˜ ì¡´ì¬: ${branchName}`);
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
                console.log(`âŒ ë¸Œëœì¹˜ ì—†ìŒ: ${branchName}`);

                // ë¸Œëœì¹˜ ì—†ìŒ ì•Œë¦¼ ëŒ“ê¸€
                const body = [
                  '## âŒ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                  '',
                  '| í•­ëª© | ê°’ |',
                  '|------|-----|',
                  `| **Issue** | #${issueNumber} |`,
                  `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
                  '',
                  '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
                  '1. ë¸Œëœì¹˜ê°€ pushë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '2. ë¸Œëœì¹˜ëª…ì´ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”',
                  '3. ë¸Œëœì¹˜ê°€ ì‚­ì œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '',
                  '---',
                  '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: body
                });
              } else {
                throw error;
              }
            }

      - name: ë¸Œëœì¹˜ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          echo "âš ï¸ ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0

      - name: Issue ì •ë³´ ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        id: issue
        run: |
          echo "ref=${{ needs.get-branch-from-issue.outputs.branch_name }}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ needs.get-branch-from-issue.outputs.issue_number }}" >> $GITHUB_OUTPUT
          # ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹ SHA ê°€ì ¸ì˜¤ê¸°
          echo "sha=$(git ls-remote https://github.com/${{ github.repository }}.git refs/heads/${{ needs.get-branch-from-issue.outputs.branch_name }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ì§„í–‰ ìƒí™© ëŒ“ê¸€ ì‹œìŠ¤í…œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
        if: steps.check_branch.outputs.exists == 'true'
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const startTime = Date.now();

            const body = [
              '## ğŸš€ Issue Preview ë¹Œë“œ ì¤‘...',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get-branch-from-issue.outputs.branch_name }}

      - name: JDK ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Gradle ê¶Œí•œ ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        run: chmod +x gradlew

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„±
      # =================================================================

      # [í•„ìˆ˜] Spring Boot ì„¤ì • íŒŒì¼
      - name: "[í•„ìˆ˜] application-prod.yml ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          mkdir -p RomRom-Web/src/main/resources
          cat << 'EOF' > ${{ env.APPLICATION_YML_PATH }}
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF

      # [ì„ íƒ] Vertex AI - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Vertex AI Service Account Key ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        env:
          VERTEX_SA_KEY: ${{ secrets.VERTEX_SA_KEY }}
        run: |
          echo "$VERTEX_SA_KEY" | sed 's/\\n/\n/g' > ./RomRom-Web/src/main/resources/gen-lang-client-0511951522-e0dc1d68cbcb.json

      # [ì„ íƒ] Firebase - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Firebase Admin SDK ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        env:
          FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          echo "$FIREBASE_KEY_JSON" | sed 's/\\n/\n/g' > ./RomRom-Web/src/main/resources/firebase-admin-sdk.json

      # [ì„ íƒ] Firebase - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] Firebase Messaging SW ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          mkdir -p RomRom-Web/src/main/resources/static
          cat << 'EOF' > ./RomRom-Web/src/main/resources/static/firebase-messaging-sw.js
          ${{ secrets.FIREBASE_MESSAGING_SW_JS }}
          EOF

      # [ì„ íƒ] AI í”„ë¡¬í”„íŠ¸ - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] price-prediction.prompt.yml ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          cat << 'EOF' > ./RomRom-Web/src/main/resources/price-prediction.prompt.yml
          ${{ secrets.PRICE_PREDICTION_PROMPT_YML }}
          EOF

      # [ì„ íƒ] ê´€ë¦¬ì ì„¤ì • - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì´ step ì‚­ì œ
      - name: "[ì„ íƒ] admin.yml ìƒì„±"
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          cat << 'EOF' > ./RomRom-Web/src/main/resources/admin.yml
          ${{ secrets.ADMIN_YML }}
          EOF

      # =================================================================
      # âš ï¸ [ì˜ì—­ 2 ë] í”„ë¡œì íŠ¸ë³„ Secret íŒŒì¼ ìƒì„± ë
      # =================================================================

      - name: Gradle ë¹Œë“œ
        if: steps.check_branch.outputs.exists == 'true'
        run: ${{ env.GRADLE_BUILD_CMD }}

      - name: ì§„í–‰ ìƒí™© - ë¹Œë“œ ì™„ë£Œ
        if: steps.check_branch.outputs.exists == 'true'
        id: build_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const startTime = ${{ steps.progress.outputs.start_time }};
            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const buildDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ Issue Preview ë¹Œë“œ ì¤‘...',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              '| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_start', now);

      - name: Docker ë¡œê·¸ì¸
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
        if: steps.check_branch.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:pr-${{ needs.get-branch-from-issue.outputs.issue_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ì§„í–‰ ìƒí™© - Docker ì™„ë£Œ
        if: steps.check_branch.outputs.exists == 'true'
        id: docker_progress
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerStart = ${{ steps.build_progress.outputs.docker_start }};
            const now = Date.now();
            const dockerElapsed = now - dockerStart;
            const minutes = Math.floor(dockerElapsed / 60000);
            const seconds = Math.floor((dockerElapsed % 60000) / 1000);
            const dockerDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## ğŸš€ Issue Preview ë¹Œë“œ ì¤‘...',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              '| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            core.setOutput('build_duration', buildDuration);
            core.setOutput('docker_duration', dockerDuration);
            core.setOutput('deploy_start', now);

      - name: ì„œë²„ì— ë°°í¬
        if: steps.check_branch.outputs.exists == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            # ë³€ìˆ˜ ì„¤ì •
            ISSUE_NUMBER=${{ needs.get-branch-from-issue.outputs.issue_number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${ISSUE_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${ISSUE_NUMBER}"
            DOMAIN="${PROJECT_NAME}-pr-${ISSUE_NUMBER}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
            INTERNAL_PORT="${{ env.INTERNAL_PORT }}"
            TRAEFIK_NETWORK="${{ env.TRAEFIK_NETWORK }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Issue Preview ë°°í¬ ì‹œì‘"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ Issue ë²ˆí˜¸: #${ISSUE_NUMBER}"
            echo "ğŸ“› ì»¨í…Œì´ë„ˆ: ${CONTAINER_NAME}"
            echo "ğŸŒ ë„ë©”ì¸: ${DOMAIN}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            echo $PW | sudo -S docker pull "${IMAGE}"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸ³ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            echo $PW | sudo -S docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${TRAEFIK_NETWORK}" \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${CONTAINER_NAME}.rule=Host(\`${DOMAIN}\`)" \
              --label "traefik.http.routers.${CONTAINER_NAME}.entrypoints=web" \
              --label "traefik.http.services.${CONTAINER_NAME}.loadbalancer.server.port=${INTERNAL_PORT}" \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=prod \
              -v /etc/localtime:/etc/localtime:ro \
              "${IMAGE}"

            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # Health Check (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°) - í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            echo ""
            echo "â³ Health Check ì‹œì‘ (ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°)..."
            MAX_RETRIES=24
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            HEALTH_CHECK_METHOD=""

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))

              # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
              STATUS=$(echo $PW | sudo -S docker inspect --format='{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "not_found")

              if [ "$STATUS" = "exited" ]; then
                echo "âŒ ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ!"
                echo ""
                echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 1
              fi

              if [ "$STATUS" = "running" ]; then
                # 2. Actuator Health Check ì‹œë„
                HEALTH=$(echo $PW | sudo -S docker exec "${CONTAINER_NAME}" wget -qO- http://localhost:${INTERNAL_PORT}/actuator/health 2>/dev/null || echo "")

                if echo "$HEALTH" | grep -q '"status":"UP"'; then
                  echo "âœ… Spring Boot ì •ìƒ ê¸°ë™ í™•ì¸! (Actuator)"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Actuator"
                  break
                fi

                # 3. Actuator ì—†ìœ¼ë©´ ë¡œê·¸ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ í´ë°±
                STARTED=$(echo $PW | sudo -S docker logs --tail 50 "${CONTAINER_NAME}" 2>&1 | grep -E "Started .* in [0-9.]+ seconds" || echo "")

                if [ -n "$STARTED" ]; then
                  echo "âœ… Spring Boot ì •ìƒ ê¸°ë™ í™•ì¸! (ë¡œê·¸ íŒ¨í„´)"
                  echo "   $STARTED"
                  HEALTH_CHECK_PASSED=true
                  HEALTH_CHECK_METHOD="Log"
                  break
                fi
              fi

              echo "â³ ëŒ€ê¸° ì¤‘... ($RETRY_COUNT/$MAX_RETRIES) - ìƒíƒœ: $STATUS"
            done

            if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
              echo ""
              echo "âŒ Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ)"
              echo ""
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo $PW | sudo -S docker logs --tail 100 "${CONTAINER_NAME}"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… ë°°í¬ ë° Health Check ì™„ë£Œ! (ë°©ì‹: ${HEALTH_CHECK_METHOD})"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ë°°í¬ ì™„ë£Œ ì½”ë©˜íŠ¸
        if: steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const buildDuration = '${{ steps.docker_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';
            const deployStart = ${{ steps.docker_progress.outputs.deploy_start }};
            const now = Date.now();
            const deployElapsed = now - deployStart;
            const minutes = Math.floor(deployElapsed / 60000);
            const seconds = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const domain = `${projectName}-pr-${issueNumber}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;

            const body = [
              '## âœ… Issue Preview ë°°í¬ ì™„ë£Œ!',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | âœ… ì™„ë£Œ | ${dockerDuration} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | âœ… ì™„ë£Œ | ${deployDuration} |`,
              '',
              '### ğŸŒ Preview í™˜ê²½',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **Preview URL** | ${previewUrl} |`,
              `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${issueNumber}\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              '',
              '### ğŸ“‹ ëª…ë ¹ì–´',
              '| ëª…ë ¹ì–´ | ì„¤ëª… |',
              '|--------|------|',
              '| `@suh-lab test build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
              '| `@suh-lab test destroy` | Preview í™˜ê²½ ì‚­ì œ |',
              '| `@suh-lab test status` | í˜„ì¬ ìƒíƒœ í™•ì¸ |',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Issue Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: ë¹Œë“œ/ë°°í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë©˜íŠ¸
        if: failure() && steps.check_branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};
            const projectName = '${{ env.PROJECT_NAME }}';
            const issueNumber = ${{ needs.get-branch-from-issue.outputs.issue_number }};
            const branchName = '${{ needs.get-branch-from-issue.outputs.branch_name }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const buildDuration = '${{ steps.build_progress.outputs.build_duration }}';
            const dockerDuration = '${{ steps.docker_progress.outputs.docker_duration }}';

            let buildStatus, dockerStatus, deployStatus;
            let buildTime = '-', dockerTime = '-';

            if (!commentId) {
              buildStatus = 'âš ï¸ ì´ˆê¸°í™” ì‹¤íŒ¨';
              dockerStatus = '-';
              deployStatus = '-';
            } else if (!buildDuration || buildDuration === '') {
              buildStatus = 'âŒ ì‹¤íŒ¨';
              dockerStatus = 'â¸ï¸ ëŒ€ê¸°';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
            } else if (!dockerDuration || dockerDuration === '') {
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âŒ ì‹¤íŒ¨';
              deployStatus = 'â¸ï¸ ëŒ€ê¸°';
              buildTime = buildDuration;
            } else {
              buildStatus = 'âœ… ì™„ë£Œ';
              dockerStatus = 'âœ… ì™„ë£Œ';
              deployStatus = 'âŒ ì‹¤íŒ¨';
              buildTime = buildDuration;
              dockerTime = dockerDuration;
            }

            const body = [
              '## âŒ Issue Preview ë°°í¬ ì‹¤íŒ¨!',
              '',
              `**ë¸Œëœì¹˜**: \`${branchName}\``,
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ | ${buildStatus} | ${buildTime} |`,
              `| ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„± | ${dockerStatus} | ${dockerTime} |`,
              `| ğŸš€ ì„œë²„ ë°°í¬ & Health Check | ${deployStatus} | - |`,
              '',
              `**[ğŸ“‹ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ í™•ì¸](${runUrl})**`,
              '',
              '### ğŸ” ê°€ëŠ¥í•œ ì›ì¸',
              '- Gradle ë¹Œë“œ ì‹¤íŒ¨',
              '- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨',
              '- ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ (Spring Boot ê¸°ë™ ì˜¤ë¥˜)',
              '- Health Check íƒ€ì„ì•„ì›ƒ (120ì´ˆ ë‚´ ê¸°ë™ ì™„ë£Œ ì•ˆë¨)',
              '',
              '### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„',
              '1. ìœ„ ë§í¬ì—ì„œ ë¹Œë“œ/ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”',
              '2. ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”: `@suh-lab test build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ Issue Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            }

  # -----------------------------------------------------------------
  # Job 4: Preview ì‚­ì œ (PR/Issue ë‹«í˜ ë˜ëŠ” destroy ëª…ë ¹)
  # -----------------------------------------------------------------
  destroy-preview:
    name: Preview ì‚­ì œ
    needs: check-command
    if: |
      always() && (
        (github.event_name == 'issue_comment' && needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'destroy') ||
        (github.event_name == 'pull_request' && github.event.action == 'closed') ||
        (github.event_name == 'issues' && github.event.action == 'closed')
      )
    runs-on: ubuntu-latest
    steps:
      - name: PR/Issue ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        id: pr_number
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=comment" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "type=pr_closed" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "type=issue_closed" >> $GITHUB_OUTPUT
          fi

      - name: ì»¨í…Œì´ë„ˆ & ì´ë¯¸ì§€ ì‚­ì œ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin
            export PW="${{ secrets.SERVER_PASSWORD }}"

            PR_NUMBER=${{ steps.pr_number.outputs.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${PR_NUMBER}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:pr-${PR_NUMBER}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ—‘ï¸ PR Preview ì‚­ì œ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
            echo "ğŸ”¢ PR ë²ˆí˜¸: #${PR_NUMBER}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ì»¨í…Œì´ë„ˆ ì‚­ì œ
            echo "ğŸ³ ì»¨í…Œì´ë„ˆ ì‚­ì œ ì¤‘..."
            echo $PW | sudo -S docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true

            # ì´ë¯¸ì§€ ì‚­ì œ
            echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            echo $PW | sudo -S docker rmi "${IMAGE}" 2>/dev/null || true

            echo "âœ… ì‚­ì œ ì™„ë£Œ!"

      - name: ì‚­ì œ ì™„ë£Œ ì½”ë©˜íŠ¸
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const number = ${{ steps.pr_number.outputs.number }};
            const projectName = '${{ env.PROJECT_NAME }}';

            const body = [
              '## ğŸ—‘ï¸ Preview í™˜ê²½ ì‚­ì œ ì™„ë£Œ!',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${number}\` |`,
              '| **ìƒíƒœ** | ì‚­ì œë¨ |',
              '',
              'ë‹¤ì‹œ ë°°í¬í•˜ë ¤ë©´: `@suh-lab test build`',
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ PR/Issue Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });

  # -----------------------------------------------------------------
  # Job 5: ìƒíƒœ í™•ì¸ (PR/Issue ëª¨ë‘ ì§€ì›)
  # -----------------------------------------------------------------
  check-status:
    name: Preview ìƒíƒœ í™•ì¸
    needs: check-command
    if: needs.check-command.outputs.is_valid == 'true' && needs.check-command.outputs.command == 'status'
    runs-on: ubuntu-latest
    steps:
      - name: ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        id: status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin

            NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${NUMBER}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Preview ìƒíƒœ í™•ì¸"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"; then
              echo "STATUS=running"
              echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
              docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"
            else
              echo "STATUS=not_found"
              echo "âŒ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ (ì‹¤í–‰ ì¤‘)
        uses: appleboy/ssh-action@v1.0.3
        id: check_running
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì‹œë†€ë¡œì§€ NASìš©)
            export PATH=$PATH:/usr/local/bin

            NUMBER=${{ github.event.issue.number }}
            PROJECT_NAME="${{ env.PROJECT_NAME }}"
            CONTAINER_NAME="${PROJECT_NAME}-pr-${NUMBER}"
            docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" | grep -q "${CONTAINER_NAME}"

      - name: ìƒíƒœ ì½”ë©˜íŠ¸ ì‘ì„±
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.issue.number;
            const projectName = '${{ env.PROJECT_NAME }}';
            const domainSuffix = '${{ env.PREVIEW_DOMAIN_SUFFIX }}';
            const previewPort = '${{ env.PREVIEW_PORT }}';
            const domain = `${projectName}-pr-${number}.${domainSuffix}`;
            const previewUrl = `http://${domain}:${previewPort}`;
            const isRunning = '${{ steps.check_running.outcome }}' === 'success';
            const isPr = '${{ needs.check-command.outputs.is_pr }}' === 'true';
            const contextType = isPr ? 'PR' : 'Issue';

            let body;
            if (isRunning) {
              body = [
                '## âœ… Preview í™˜ê²½ ì‹¤í–‰ ì¤‘',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **Preview URL** | ${previewUrl} |`,
                `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${number}\` |`,
                '| **ìƒíƒœ** | ğŸŸ¢ Running |',
                '',
                '### ğŸ“‹ ëª…ë ¹ì–´',
                '| ëª…ë ¹ì–´ | ì„¤ëª… |',
                '|--------|------|',
                '| `@suh-lab test build` | ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ |',
                '| `@suh-lab test destroy` | Preview í™˜ê²½ ì‚­ì œ |',
                '',
                '---',
                `*ğŸ¤– ì´ ëŒ“ê¸€ì€ ${contextType} Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
              ].join('\n');
            } else {
              body = [
                '## âŒ Preview í™˜ê²½ ì—†ìŒ',
                '',
                '| í•­ëª© | ê°’ |',
                '|------|-----|',
                `| **ì»¨í…Œì´ë„ˆ** | \`${projectName}-pr-${number}\` |`,
                '| **ìƒíƒœ** | ğŸ”´ Not Found |',
                '',
                'ë°°í¬í•˜ë ¤ë©´: `@suh-lab test build`',
                '',
                '---',
                `*ğŸ¤– ì´ ëŒ“ê¸€ì€ ${contextType} Preview ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: body
            });
