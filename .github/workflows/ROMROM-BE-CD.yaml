name: í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
on:
  pull_request:
    branches: ["test"]

# PR ëŒ“ê¸€ì„ ìœ„í•œ ê¶Œí•œ ì¶”ê°€
permissions:
  contents: read
  pull-requests: write

jobs:
  test-project-build:
    name: í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        id: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Java ì„¤ì •
        id: setup-java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: gradle

      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
        id: setup-gradle
        run: chmod +x gradlew

      - name: í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±
        id: create-config
        run: |
          mkdir -p src/main/resources
          echo "${{ secrets.APPLICATION_PROD_YML }}" > ./src/main/resources/application-prod.yml
          echo "$VERTEX_SA_KEY" | sed 's/\\n/\n/g' > ./src/main/resources/gen-lang-client-0511951522-a173c85ef515.json
        env:
          VERTEX_SA_KEY: ${{ secrets.VERTEX_SA_KEY }}

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        id: build-project
        run: |
          # ë¹Œë“œ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
          ./gradlew clean build -x test -Dspring.profiles.active=prod > build_output.txt 2>&1 || {
            echo "BUILD_FAILED=true" >> $GITHUB_ENV
            echo "BUILD_OUTPUT<<EOF" >> $GITHUB_ENV
            # ì—ëŸ¬ ë©”ì‹œì§€ ì¤‘ ì¤‘ìš”í•œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
            grep -E "(error|Error|FAILURE|BUILD FAILED)" build_output.txt | head -20 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            # ì»´íŒŒì¼ ì—ëŸ¬ ìƒì„¸ ì •ë³´ ì¶”ì¶œ
            echo "COMPILE_ERRORS<<EOF" >> $GITHUB_ENV
            grep -A 5 -B 5 "error:" build_output.txt | head -30 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            exit 1
          }

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
        id: check-artifacts
        run: |
          if [ ! -f "build/libs/"*.jar ]; then
            echo "ARTIFACT_CHECK_FAILED=true" >> $GITHUB_ENV
            echo "ARTIFACT_ERROR=JAR íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!" >> $GITHUB_ENV
            exit 1
          fi
          
          # JAR íŒŒì¼ ì •ë³´ ìˆ˜ì§‘
          JAR_FILE=$(ls build/libs/*.jar | head -1)
          JAR_SIZE=$(ls -lh "$JAR_FILE" | awk '{print $5}')
          echo "JAR_FILE_NAME=$(basename "$JAR_FILE")" >> $GITHUB_ENV
          echo "JAR_FILE_SIZE=$JAR_SIZE" >> $GITHUB_ENV

      - name: ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„±
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jarFileName = process.env.JAR_FILE_NAME;
            const jarFileSize = process.env.JAR_FILE_SIZE;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ**

              ğŸ‰ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

              **ë¹Œë“œ ê²°ê³¼:**
              - JAR íŒŒì¼: \`${jarFileName}\`
              - íŒŒì¼ í¬ê¸°: ${jarFileSize}
              - ë¹Œë“œ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

              **ë‹¤ìŒ ë‹¨ê³„:**
              - ë°°í¬ ì¤€ë¹„ ì™„ë£Œ âœ…
              - ëª¨ë“  ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°ë¨ âœ…`
            })

      - name: ì»´íŒŒì¼ ì—ëŸ¬ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.BUILD_FAILED == 'true' && env.COMPILE_ERRORS != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const compileErrors = process.env.COMPILE_ERRORS;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨ - ì»´íŒŒì¼ ì—ëŸ¬**

              ğŸ’¥ ì†ŒìŠ¤ì½”ë“œ ì»´íŒŒì¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

              **ì»´íŒŒì¼ ì—ëŸ¬ ìƒì„¸:**
              \`\`\`
              ${compileErrors}
              \`\`\`

              **í•´ê²° ë°©ë²•:**
              1. ëˆ„ë½ëœ import ë¬¸ì„ ì¶”ê°€í•˜ì„¸ìš”
              2. í´ë˜ìŠ¤ë‚˜ ë©”ì„œë“œëª…ì„ í™•ì¸í•˜ì„¸ìš”
              3. íƒ€ì… ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”
              4. ì˜ì¡´ì„± ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”

              **ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œ:**
              - \`cannot find symbol\`: í´ë˜ìŠ¤ë‚˜ ë³€ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
              - \`package does not exist\`: íŒ¨í‚¤ì§€ ê²½ë¡œ ì˜¤ë¥˜
              - ì–´ë…¸í…Œì´ì…˜ ê´€ë ¨ ì˜¤ë¥˜: ì˜ì¡´ì„± ëˆ„ë½`
            })

      - name: ì¼ë°˜ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.BUILD_FAILED == 'true' && env.COMPILE_ERRORS == ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildOutput = process.env.BUILD_OUTPUT;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨**

              ğŸ”§ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

              **ë¹Œë“œ ì—ëŸ¬:**
              \`\`\`
              ${buildOutput}
              \`\`\`

              **í•´ê²° ë°©ë²•:**
              1. Gradle ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš” (\`build.gradle\`)
              2. ì˜ì¡´ì„± ë²„ì „ ì¶©ëŒì„ í™•ì¸í•˜ì„¸ìš”
              3. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”
              4. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”`
            })

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.ARTIFACT_CHECK_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifactError = process.env.ARTIFACT_ERROR;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ì‹¤íŒ¨**

              ğŸ“¦ ë¹Œë“œëŠ” ì™„ë£Œë˜ì—ˆì§€ë§Œ ê²°ê³¼ë¬¼ ìƒì„±ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

              **ì˜¤ë¥˜:**
              ${artifactError}

              **í•´ê²° ë°©ë²•:**
              1. \`build.gradle\`ì˜ JAR ìƒì„± ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”
              2. ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ì˜ ì¶œë ¥ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”
              3. ë©”ì¸ í´ë˜ìŠ¤ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”`
            })

      - name: ê¸°íƒ€ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„±
        if: failure() && env.BUILD_FAILED != 'true' && env.ARTIFACT_CHECK_FAILED != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ì‹¤íŒ¨í•œ ë‹¨ê³„ ì°¾ê¸°
            let failedStep = 'ì•Œ ìˆ˜ ì—†ëŠ” ë‹¨ê³„';
            
            if ('${{ steps.checkout.outcome }}' === 'failure') failedStep = 'ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ';
            else if ('${{ steps.setup-java.outcome }}' === 'failure') failedStep = 'Java í™˜ê²½ ì„¤ì •';
            else if ('${{ steps.setup-gradle.outcome }}' === 'failure') failedStep = 'Gradle ê¶Œí•œ ì„¤ì •';
            else if ('${{ steps.create-config.outcome }}' === 'failure') failedStep = 'í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨**

              âš™ï¸ **ì‹¤íŒ¨í•œ ë‹¨ê³„:** ${failedStep}

              **í•´ê²° ë°©ë²•:**
              1. GitHub Actions ë¡œê·¸ë¥¼ ìƒì„¸íˆ í™•ì¸í•˜ì„¸ìš”
              2. í™˜ê²½ ì„¤ì • ë° ì‹œí¬ë¦¿ ê°’ë“¤ì„ í™•ì¸í•˜ì„¸ìš”
              3. ì›Œí¬í”Œë¡œìš° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”

              [ë¹Œë“œ ë¡œê·¸ í™•ì¸í•˜ê¸°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })