<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title layout:fragment="title">대시보드</title>
</head>
<body>
<div layout:fragment="content">
    <!-- 통계 카드 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- 전체 회원 -->
        <div class="stat bg-base-100 rounded-box shadow">
            <div class="stat-figure text-primary">
                <i data-lucide="users" class="size-8"></i>
            </div>
            <div class="stat-title">전체 회원</div>
            <div class="stat-value text-primary" th:text="${totalMembers != null ? totalMembers : 0}">0</div>
            <div class="stat-desc">명</div>
        </div>

        <!-- 등록 물품 -->
        <div class="stat bg-base-100 rounded-box shadow">
            <div class="stat-figure text-success">
                <i data-lucide="package" class="size-8"></i>
            </div>
            <div class="stat-title">등록 물품</div>
            <div class="stat-value text-success" th:text="${totalItems != null ? totalItems : 0}">0</div>
            <div class="stat-desc">개</div>
        </div>

        <!-- 진행중 거래 -->
        <div class="stat bg-base-100 rounded-box shadow">
            <div class="stat-figure text-warning">
                <i data-lucide="repeat" class="size-8"></i>
            </div>
            <div class="stat-title">진행중 거래</div>
            <div class="stat-value text-warning">-</div>
            <div class="stat-desc">건</div>
        </div>

        <!-- 신고 접수 -->
        <div class="stat bg-base-100 rounded-box shadow">
            <div class="stat-figure text-error">
                <i data-lucide="flag" class="size-8"></i>
            </div>
            <div class="stat-title">신고 접수</div>
            <div class="stat-value text-error">-</div>
            <div class="stat-desc">건</div>
        </div>
    </div>

    <!-- 최근 활동 섹션 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- 최근 가입 회원 -->
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title text-base">
                    <i data-lucide="user-plus" class="size-5"></i>
                    최근 가입 회원
                    <span id="membersBadge" class="badge badge-primary badge-sm">로딩중</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm" id="recentMembersTable">
                        <thead>
                        <tr>
                            <th>프로필</th>
                            <th>닉네임</th>
                            <th>가입일</th>
                        </tr>
                        </thead>
                        <tbody id="recentMembersBody">
                        <tr>
                            <td colspan="3" class="text-center">
                                <span class="loading loading-spinner loading-sm"></span> 불러오는 중...
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-actions justify-end mt-2">
                    <a th:href="@{/admin/members}" class="btn btn-ghost btn-sm">전체 보기</a>
                </div>
            </div>
        </div>

        <!-- 최근 등록 물품 -->
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title text-base">
                    <i data-lucide="package-plus" class="size-5"></i>
                    최근 등록 물품
                </h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm" id="recentItemsTable">
                        <thead>
                        <tr>
                            <th>이미지</th>
                            <th>물품명</th>
                            <th>가격</th>
                            <th>판매자</th>
                            <th>등록일</th>
                        </tr>
                        </thead>
                        <tbody id="recentItemsBody">
                        <tr>
                            <td colspan="5" class="text-center">
                                <span class="loading loading-spinner loading-sm"></span> 불러오는 중...
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-actions justify-end mt-2">
                    <a th:href="@{/admin/items}" class="btn btn-ghost btn-sm">전체 보기</a>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="js">
    <script>
        // 대시보드 데이터 로드
        function loadDashboardData() {
            loadRecentMembers();
            loadRecentItems();
        }

        function loadRecentMembers() {
            fetch('/api/admin/dashboard/recent-members')
                .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
                .then(data => {
                    if (data.members && data.members.content) {
                        renderRecentMembers(data.members.content);
                    }
                })
                .catch(e => console.error('최근 회원 로드 실패:', e));
        }

        function loadRecentItems() {
            fetch('/api/admin/dashboard/recent-items')
                .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
                .then(data => {
                    if (data.items && data.items.content) {
                        renderRecentItems(data.items.content);
                    }
                })
                .catch(e => console.error('최근 물품 로드 실패:', e));
        }

        function renderRecentMembers(members) {
            const tbody = document.getElementById('recentMembersBody');
            const badge = document.getElementById('membersBadge');
            if (!tbody) return;

            if (!members || members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-base-content/60">등록된 회원이 없습니다.</td></tr>';
                if (badge) badge.textContent = '0명';
                return;
            }

            if (badge) badge.textContent = `${members.length}명`;

            tbody.innerHTML = members.map(m => `
                <tr>
                    <td>
                        <div class="avatar">
                            <div class="w-8 rounded-full">
                                <img src="${m.profileUrl ? escapeHtml(m.profileUrl) : '/assets/img/default-150x150.png'}" alt="프로필"/>
                            </div>
                        </div>
                    </td>
                    <td class="font-medium">${escapeHtml(m.nickname) || '익명'}</td>
                    <td class="text-base-content/60 text-sm">${TimeUtils.getRelativeTime(m.createdDate)}</td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        function renderRecentItems(items) {
            const tbody = document.getElementById('recentItemsBody');
            if (!tbody) return;

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-base-content/60">등록된 물품이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>
                        <div class="avatar">
                            <div class="w-10 rounded">
                                <img src="${item.mainImageUrl ? escapeHtml(item.mainImageUrl) : '/assets/img/default-150x150.png'}" alt="물품"/>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="font-medium text-sm truncate max-w-32">${escapeHtml(item.itemName) || '-'}</div>
                    </td>
                    <td class="text-sm">${NumberUtils.formatPrice(item.price)}</td>
                    <td class="text-sm text-base-content/60">${escapeHtml(item.sellerNickname) || '익명'}</td>
                    <td class="text-sm text-base-content/60">${TimeUtils.getRelativeTime(item.createdDate)}</td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        loadDashboardData();
    </script>
</th:block>
</body>
</html>
