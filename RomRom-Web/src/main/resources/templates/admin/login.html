<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="color-scheme" content="light dark">
    <title>RomRom Admin | 관리자 로그인</title>
    
    <!-- Fonts -->
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
          integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
          crossorigin="anonymous">
    
    <!-- OverlayScrollbars -->
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"
          crossorigin="anonymous">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
          crossorigin="anonymous">
    
    <!-- AdminLTE CSS -->
    <link rel="stylesheet" th:href="@{/css/adminlte.min.css}">
    
    <!-- Common CSS -->
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body class="login-page">
    <div class="login-box">
        <div class="card card-outline card-romrom-primary">
            <div class="card-header text-center py-4">
                <a href="/admin">
                    <img th:src="@{/assets/img/login-romrom-text.svg}" alt="RomRom" style="height: 40px;">
                </a>
            </div>
            <div class="card-body login-card-body">
                <p class="login-box-msg">
                    <small class="text-muted">
                        <i class="bi bi-shield-lock-fill me-1"></i>
                        RomRom 관리자 전용 페이지<br>
                    </small>
                </p>

                <!-- 알림 메시지들 -->
                <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    아이디 또는 비밀번호가 올바르지 않습니다.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <div th:if="${param.logout}" class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    로그아웃되었습니다.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <div th:if="${param.sessionExpired}" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="bi bi-clock-history me-2"></i>
                    세션이 만료되었습니다. 다시 로그인해주세요.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <div th:if="${param.maxSessions}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-person-fill-x me-2"></i>
                    최대 접속 인원(10명)을 초과했습니다.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <!-- 로그인 폼 -->
                <form id="loginForm">
                    <div class="input-group mb-3">
                        <div class="form-floating flex-grow-1">
                            <input id="loginUsername" 
                                   name="username" 
                                   type="text" 
                                   class="form-control" 
                                   placeholder="" 
                                   required 
                                   autofocus>
                            <label for="loginUsername">관리자 아이디</label>
                        </div>
                        <div class="input-group-text">
                            <span class="bi bi-person-fill"></span>
                        </div>
                    </div>
                    
                    <div class="input-group mb-3">
                        <div class="form-floating flex-grow-1">
                            <input id="loginPassword" 
                                   name="password" 
                                   type="password" 
                                   class="form-control" 
                                   placeholder="" 
                                   required>
                            <label for="loginPassword">비밀번호</label>
                        </div>
                        <div class="input-group-text">
                            <span class="bi bi-lock-fill"></span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-8 d-inline-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       value="remember-me" 
                                       id="rememberMe" 
                                       name="remember-me">
                                <label class="form-check-label" for="rememberMe">
                                    로그인 상태 유지
                                </label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-romrom-primary" id="loginBtn">
                                    <i class="bi bi-box-arrow-in-right me-1"></i> 로그인
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- /.login-card-body -->
        </div>
        
        <div class="text-center mt-3">
            <small class="text-muted">
                &copy; 2025 RomRom. All rights reserved.
            </small>
        </div>
    </div>
    <!-- /.login-box -->
    
    <!-- OverlayScrollbars -->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"
            crossorigin="anonymous"></script>
    
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            crossorigin="anonymous"></script>
    
    <!-- Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"
            crossorigin="anonymous"></script>
    
    <!-- AdminLTE JS -->
    <script th:src="@{/js/adminlte.min.js}"></script>
    
    <!-- Common JS -->
    <script th:src="@{/js/common.js}"></script>
    
    <!-- OverlayScrollbars Configure -->
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
        const Default = {
            scrollbarTheme: 'os-theme-light',
            scrollbarAutoHide: 'leave',
            scrollbarClickScroll: true,
        };
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && OverlayScrollbarsGlobal?.OverlayScrollbars !== undefined) {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.scrollbarClickScroll,
                    },
                });
            }
        });
    </script>
    
    <!-- JWT 로그인 처리 스크립트 -->
    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const originalBtnHtml = loginBtn.innerHTML;
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 로그인 중...';
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // 로그인 성공 - accessToken을 localStorage에 저장
                    const data = await response.json();
                    console.log('로그인 성공:', data);
                    
                    // accessToken을 localStorage에 저장 (클라이언트 선택)
                    if (data.accessToken) {
                        localStorage.setItem('adminAccessToken', data.accessToken);
                    }
                    
                    // refreshToken은 쿠키로 자동 설정됨
                    // 잠시 대기 후 리다이렉트 (쿠키 설정 완료를 위해)
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 100);
                } else {
                    // 에러 응답 처리
                    const errorData = await response.json();
                    showError(errorData.message || '아이디 또는 비밀번호가 올바르지 않습니다.');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = originalBtnHtml;
                }
            } catch (error) {
                console.error('로그인 에러:', error);
                showError('로그인 처리 중 오류가 발생했습니다.');
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalBtnHtml;
            }
        });
        
        function showError(message) {
            // 기존 알림 제거
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 새 알림 추가
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            const form = document.getElementById('loginForm');
            form.insertAdjacentHTML('beforebegin', alertHtml);
        }
    </script>
</body>
</html>