<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title layout:fragment="title">물품 관리</title>
</head>
<body>
<div layout:fragment="content">
    <!-- 검색 및 필터 -->
    <div class="card bg-base-100 shadow mb-4">
        <div class="card-body">
            <h2 class="card-title text-base mb-3">
                <i data-lucide="search" class="size-5"></i>
                검색 및 필터
            </h2>
            <form id="filterForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    <fieldset class="fieldset">
                        <label class="fieldset-label">검색 키워드</label>
                        <input type="text" id="searchKeyword" class="input w-full"
                               placeholder="물품명, 설명, 판매자"/>
                    </fieldset>

                    <fieldset class="fieldset">
                        <label class="fieldset-label">카테고리</label>
                        <select id="itemCategory" class="select w-full">
                            <option value="">전체</option>
                            <option value="WOMEN_CLOTHING">여성의류</option>
                            <option value="MEN_CLOTHING">남성의류</option>
                            <option value="SHOES">신발</option>
                            <option value="BAGS_WALLETS">가방/지갑</option>
                            <option value="WATCHES">시계</option>
                            <option value="JEWELRY">주얼리</option>
                            <option value="FASHION_ACCESSORIES">패션 액세서리</option>
                            <option value="ELECTRONICS_SMART_DEVICES">전자기기/스마트기기</option>
                            <option value="LARGE_APPLIANCES">대형가전</option>
                            <option value="SMALL_APPLIANCES">소형가전</option>
                            <option value="SPORTS_LEISURE">스포츠/레저</option>
                            <option value="VEHICLES_MOTORCYCLES">차량/오토바이</option>
                            <option value="STAR_GOODS">스타굿즈</option>
                            <option value="KIDULT">키덜트</option>
                            <option value="ART_RARE_COLLECTIBLES">예술/희귀/수집품</option>
                            <option value="MUSIC_INSTRUMENTS">음반/악기</option>
                            <option value="BOOKS_TICKETS_STATIONERY">도서/티켓/문구</option>
                            <option value="BEAUTY">뷰티/미용</option>
                            <option value="FURNITURE_INTERIOR">가구/인테리어</option>
                            <option value="LIFE_KITCHEN">생활/주방용품</option>
                            <option value="TOOLS_INDUSTRIAL">공구/산업용품</option>
                            <option value="FOOD">식품</option>
                            <option value="BABY">유아용품</option>
                            <option value="PET_PRODUCTS">반려동물용품</option>
                            <option value="OTHER">기타</option>
                            <option value="SKILL">재능 (서비스/기술 교환)</option>
                        </select>
                    </fieldset>

                    <fieldset class="fieldset">
                        <label class="fieldset-label">물품 상태</label>
                        <select id="itemCondition" class="select w-full">
                            <option value="">전체</option>
                            <option value="SEALED">미개봉</option>
                            <option value="SLIGHTLY_USED">사용감 적음</option>
                            <option value="MODERATELY_USED">사용감 적당함</option>
                            <option value="HEAVILY_USED">사용감 많음</option>
                        </select>
                    </fieldset>

                    <fieldset class="fieldset">
                        <label class="fieldset-label">거래 상태</label>
                        <select id="itemStatus" class="select w-full">
                            <option value="">전체</option>
                            <option value="AVAILABLE">교환가능</option>
                            <option value="EXCHANGED">교환완료</option>
                        </select>
                    </fieldset>

                    <fieldset class="fieldset">
                        <label class="fieldset-label">정렬</label>
                        <select id="sortBy" class="select w-full">
                            <option value="createdDate">등록일</option>
                            <option value="updatedDate">수정일</option>
                            <option value="itemName">물품명</option>
                            <option value="price">가격</option>
                            <option value="likeCount">좋아요수</option>
                        </select>
                    </fieldset>

                    <fieldset class="fieldset">
                        <label class="fieldset-label">정렬 방향</label>
                        <select id="sortDirection" class="select w-full">
                            <option value="DESC">내림차순</option>
                            <option value="ASC">오름차순</option>
                        </select>
                    </fieldset>

                    <fieldset class="fieldset">
                        <label class="fieldset-label">페이지 크기</label>
                        <select id="pageSize" class="select w-full">
                            <option value="10">10개</option>
                            <option value="20" selected>20개</option>
                            <option value="50">50개</option>
                            <option value="100">100개</option>
                        </select>
                    </fieldset>
                </div>

                <div class="flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i data-lucide="search" class="size-4"></i> 검색
                    </button>
                    <button type="button" class="btn btn-ghost btn-sm" onclick="resetFilters()">
                        <i data-lucide="rotate-ccw" class="size-4"></i> 초기화
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 물품 목록 -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="flex items-center justify-between mb-3">
                <h2 class="card-title text-base">
                    <i data-lucide="list" class="size-5"></i>
                    물품 목록
                </h2>
                <span id="totalCount" class="badge badge-info">로딩 중...</span>
            </div>

            <!-- 로딩 -->
            <div id="loading" class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>

            <!-- 테이블 -->
            <div class="overflow-x-auto" id="tableContainer" style="display:none;">
                <table class="table table-sm" id="itemsTable">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>이미지</th>
                        <th>물품명</th>
                        <th>판매자</th>
                        <th>가격</th>
                        <th>카테고리</th>
                        <th>물품상태</th>
                        <th>거래상태</th>
                        <th>좋아요</th>
                        <th>등록일</th>
                        <th>관리</th>
                    </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <div class="flex items-center justify-between mt-4" id="paginationContainer" style="display:none;">
                <span id="pageInfo" class="text-sm text-base-content/60"></span>
                <div class="join" id="pagination"></div>
            </div>
        </div>
    </div>

    <!-- 물품 상세 모달 -->
    <dialog id="itemDetailModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="text-lg font-bold mb-4">물품 상세 정보</h3>
            <div id="itemDetailContent">
                <span class="loading loading-spinner"></span>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">닫기</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- 삭제 확인 모달 -->
    <dialog id="deleteConfirmModal" class="modal">
        <div class="modal-box">
            <h3 class="text-lg font-bold">물품 삭제</h3>
            <p class="py-4">정말로 이 물품을 삭제하시겠습니까? 삭제된 물품은 복구할 수 없습니다.</p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost">취소</button>
                </form>
                <button id="confirmDeleteBtn" class="btn btn-error">삭제</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</div>

<th:block layout:fragment="js">
    <script>
        let currentPage = 0;
        let currentPageSize = 20;
        let deleteTargetId = null;

        // 상세보기용 아이템 캐시
        let itemsCache = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadItems();

            document.getElementById('filterForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 0;
                loadItems();
            });

            document.getElementById('pageSize').addEventListener('change', function() {
                currentPageSize = parseInt(this.value);
                currentPage = 0;
                loadItems();
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                if (deleteTargetId) executeDelete(deleteTargetId);
            });
        });

        function loadItems() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('paginationContainer').style.display = 'none';

            const params = new URLSearchParams();
            params.append('pageNumber', currentPage);
            params.append('pageSize', currentPageSize);

            const fields = ['searchKeyword','itemCategory','itemCondition','itemStatus','sortBy','sortDirection'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value) params.append(id, el.value);
            });
            if (!params.has('sortBy')) params.append('sortBy', 'createdDate');
            if (!params.has('sortDirection')) params.append('sortDirection', 'DESC');

            fetch(`/api/admin/items?${params.toString()}`)
                .then(r => {
                    if (r.status === 401) { window.location.href = '/admin/login'; return; }
                    if (!r.ok) throw new Error(r.status);
                    return r.json();
                })
                .then(data => renderItems(data))
                .catch(e => {
                    console.error('물품 로드 실패:', e);
                    document.getElementById('loading').style.display = 'none';
                });
        }

        const categoryMap = {
            'WOMEN_CLOTHING':'여성의류','MEN_CLOTHING':'남성의류','SHOES':'신발',
            'BAGS_WALLETS':'가방/지갑','WATCHES':'시계','JEWELRY':'주얼리',
            'FASHION_ACCESSORIES':'패션 액세서리','ELECTRONICS_SMART_DEVICES':'전자기기/스마트기기',
            'LARGE_APPLIANCES':'대형가전','SMALL_APPLIANCES':'소형가전',
            'SPORTS_LEISURE':'스포츠/레저','VEHICLES_MOTORCYCLES':'차량/오토바이',
            'STAR_GOODS':'스타굿즈','KIDULT':'키덜트',
            'ART_RARE_COLLECTIBLES':'예술/희귀/수집품','MUSIC_INSTRUMENTS':'음반/악기',
            'BOOKS_TICKETS_STATIONERY':'도서/티켓/문구','BEAUTY':'뷰티/미용',
            'FURNITURE_INTERIOR':'가구/인테리어','LIFE_KITCHEN':'생활/주방용품',
            'TOOLS_INDUSTRIAL':'공구/산업용품','FOOD':'식품','BABY':'유아용품',
            'PET_PRODUCTS':'반려동물용품','OTHER':'기타','SKILL':'재능 (서비스/기술 교환)'
        };
        const conditionMap = {
            'SEALED':'미개봉','SLIGHTLY_USED':'사용감 적음',
            'MODERATELY_USED':'사용감 적당함','HEAVILY_USED':'사용감 많음'
        };
        const statusMap = {
            'AVAILABLE': {text:'교환가능', cls:'badge-success'},
            'EXCHANGED': {text:'교환완료', cls:'badge-neutral'}
        };

        function renderItems(response) {
            const itemsPage = response.items;
            const totalElements = itemsPage.totalElements || 0;

            // 상세보기용 캐시 저장
            itemsCache = {};
            if (itemsPage.content) {
                itemsPage.content.forEach(item => { itemsCache[item.itemId] = item; });
            }

            document.getElementById('totalCount').textContent = `총 ${totalElements.toLocaleString()}개`;

            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';

            if (itemsPage.content && itemsPage.content.length > 0) {
                tbody.innerHTML = itemsPage.content.map(item => {
                    const shortId = escapeHtml(item.itemId.substring(0, 8));
                    const status = statusMap[item.itemStatus] || {text: escapeHtml(item.itemStatus) || '-', cls:'badge-neutral'};
                    const imgHtml = item.mainImageUrl
                        ? `<div class="avatar"><div class="w-10 rounded"><img src="${escapeHtml(item.mainImageUrl)}" alt="물품"/></div></div>`
                        : '<span class="badge badge-ghost badge-sm">없음</span>';

                    return `
                        <tr>
                            <td class="text-xs font-mono">${shortId}</td>
                            <td>${imgHtml}</td>
                            <td class="max-w-40 truncate">${escapeHtml(item.itemName) || '-'}</td>
                            <td>${escapeHtml(item.sellerNickname) || '-'}</td>
                            <td>${item.price ? item.price.toLocaleString() + '원' : '-'}</td>
                            <td>${categoryMap[item.itemCategory] || '-'}</td>
                            <td>${conditionMap[item.itemCondition] || '-'}</td>
                            <td><span class="badge ${status.cls} badge-sm">${status.text}</span></td>
                            <td>${item.likeCount || 0}</td>
                            <td class="text-sm">${TimeUtils.formatDate(item.createdDate)}</td>
                            <td>
                                <div class="flex gap-1">
                                    <button class="btn btn-ghost btn-xs" onclick="viewItemDetail('${escapeHtml(item.itemId)}')">
                                        <i data-lucide="eye" class="size-4"></i>
                                    </button>
                                    <button class="btn btn-ghost btn-xs text-error" onclick="confirmDelete('${escapeHtml(item.itemId)}')">
                                        <i data-lucide="trash-2" class="size-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                renderPagination(itemsPage);
                const start = itemsPage.number * itemsPage.size + 1;
                const end = Math.min(start + itemsPage.size - 1, itemsPage.totalElements);
                document.getElementById('pageInfo').textContent = `${start}-${end} / ${itemsPage.totalElements}`;
                document.getElementById('paginationContainer').style.display = 'flex';
            } else {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-base-content/60 py-8">검색된 물품이 없습니다.</td></tr>';
                document.getElementById('paginationContainer').style.display = 'none';
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            lucide.createIcons();
        }

        function renderPagination(itemsPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (itemsPage.totalPages <= 1) return;

            const cur = itemsPage.number;
            const total = itemsPage.totalPages;

            // 이전 버튼
            pagination.innerHTML += `<button class="join-item btn btn-sm ${cur === 0 ? 'btn-disabled' : ''}"
                onclick="changePage(${cur - 1})">&laquo;</button>`;

            const start = Math.max(0, cur - 2);
            const end = Math.min(total - 1, cur + 2);

            for (let i = start; i <= end; i++) {
                pagination.innerHTML += `<button class="join-item btn btn-sm ${i === cur ? 'btn-active' : ''}"
                    onclick="changePage(${i})">${i + 1}</button>`;
            }

            pagination.innerHTML += `<button class="join-item btn btn-sm ${cur === total - 1 ? 'btn-disabled' : ''}"
                onclick="changePage(${cur + 1})">&raquo;</button>`;
        }

        function changePage(page) {
            if (page < 0) return;
            currentPage = page;
            loadItems();
        }

        function resetFilters() {
            document.getElementById('filterForm').reset();
            document.getElementById('pageSize').value = '20';
            currentPage = 0;
            currentPageSize = 20;
            loadItems();
        }

        function confirmDelete(itemId) {
            deleteTargetId = itemId;
            document.getElementById('deleteConfirmModal').showModal();
        }

        function executeDelete(itemId) {
            document.getElementById('deleteConfirmModal').close();

            fetch(`/api/admin/items/${itemId}`, { method: 'DELETE' })
                .then(r => {
                    if (r.status === 401) { window.location.href = '/admin/login'; return; }
                    if (!r.ok) throw new Error(r.status);
                    return r.text();
                })
                .then(() => loadItems())
                .catch(e => console.error('삭제 실패:', e));

            deleteTargetId = null;
        }

        function viewItemDetail(itemId) {
            const modal = document.getElementById('itemDetailModal');
            const content = document.getElementById('itemDetailContent');
            modal.showModal();

            const item = itemsCache[itemId];
            if (item) {
                const status = statusMap[item.itemStatus] || {text: escapeHtml(item.itemStatus) || '-', cls:'badge-neutral'};
                content.innerHTML = `
                    ${item.mainImageUrl ? `<img src="${escapeHtml(item.mainImageUrl)}" alt="물품" class="w-full max-w-sm rounded-lg mb-4"/>` : ''}
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-base-content/60">물품 ID</div><div class="font-mono text-xs">${escapeHtml(item.itemId)}</div>
                        <div class="text-base-content/60">물품명</div><div class="font-medium">${escapeHtml(item.itemName) || '-'}</div>
                        <div class="text-base-content/60">설명</div><div>${escapeHtml(item.itemDescription) || '-'}</div>
                        <div class="text-base-content/60">카테고리</div><div>${categoryMap[item.itemCategory] || escapeHtml(item.itemCategory) || '-'}</div>
                        <div class="text-base-content/60">물품 상태</div><div>${conditionMap[item.itemCondition] || escapeHtml(item.itemCondition) || '-'}</div>
                        <div class="text-base-content/60">거래 상태</div><div><span class="badge ${status.cls} badge-sm">${status.text}</span></div>
                        <div class="text-base-content/60">가격</div><div>${item.price ? item.price.toLocaleString() + '원' : '-'}</div>
                        <div class="text-base-content/60">좋아요</div><div>${item.likeCount || 0}개</div>
                        <div class="text-base-content/60">판매자</div><div>${escapeHtml(item.sellerNickname) || '-'}</div>
                        <div class="text-base-content/60">등록일</div><div>${TimeUtils.formatDateTime(item.createdDate)}</div>
                    </div>
                `;
            } else {
                content.innerHTML = '<p class="text-error">물품 정보를 불러올 수 없습니다.</p>';
            }
        }
    </script>
</th:block>
</body>
</html>
