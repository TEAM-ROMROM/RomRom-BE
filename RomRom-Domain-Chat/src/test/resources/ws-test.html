<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸ v3 (ìˆ˜ì •)</title>
    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; }
        /* â—ï¸ 1. ìˆ˜ì •: flex-direction: column-reverse ì œê±° */
        .chat-window {
            display: flex;
            flex-direction: column; /* (ê¸°ë³¸ê°’) ìœ„ì—ì„œ ì•„ë˜ë¡œ ìŒ“ì´ë„ë¡ */
        }
        .msg { word-break: break-word; white-space: pre-wrap; }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen">

<div class="w-full max-w-md bg-white shadow-xl rounded-lg flex flex-col" style="height: 80vh;">

    <!-- 1. ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="controls-panel" class="p-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-center mb-4">ì—°ê²° ì •ë³´</h2>
        <div class="space-y-2">
            <input id="token" class="w-full px-3 py-2 border rounded-md" placeholder="JWT í† í°">
            <input id="myId" class="w-full px-3 py-2 border rounded-md" placeholder="ë³¸ì¸ Member UUID">
            <input id="chatRoomId" class="w-full px-3 py-2 border rounded-md" placeholder="ì±„íŒ…ë°© UUID (ChatRoomId)">
        </div>
        <button id="connect-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md mt-4 hover:bg-blue-600 transition">
            ì±„íŒ…ë°© ì…ì¥
        </button>
    </div>

    <!-- 2. ìƒë‹¨ í—¤ë” (ì—°ê²° í›„) -->
    <div id="chat-header" class="hidden p-4 border-b border-gray-200 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div id="status-pill" class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span id="status-text" class="font-semibold text-gray-600">ì—°ê²° ëŠê¹€</span>
        </div>
        <button id="disconnect-btn" class="bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-md hover:bg-red-600 transition">
            ì—°ê²° ëŠê¸°
        </button>
    </div>

    <!-- 3. ì±„íŒ…ì°½ -->
    <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100">
        <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ (ì•„ë˜ì—ì„œ ìœ„ë¡œ) -->
    </div>

    <!-- 4. ì±„íŒ… ì…ë ¥ì°½ -->
    <div id="chat-input-area" class="hidden p-4 border-t border-gray-200 flex space-x-2">
        <input id="message-input" class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="send-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition">
            ì „ì†¡
        </button>
    </div>

    <!-- 5. ì•ˆ ì½ìŒ í™•ì¸ íŒ¨ë„ (ì—°ê²° ëŠì€ í›„) -->
    <div id="unread-check-panel" class="hidden p-4 border-t border-gray-200 text-center">
        <p class="text-sm text-gray-600 mb-2">ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì•ˆ ì½ì€ ë©”ì‹œì§€ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
        <button id="check-unread-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition">
            ë°©ê¸ˆ ë‚˜ê°„ ë°© ì•ˆì½ìŒ ì •ë³´ í™•ì¸
        </button>
        <pre id="unread-result" class="mt-4 p-3 bg-gray-100 rounded-md text-left text-sm overflow-auto"></pre>
    </div>
</div>

<script>
    // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • ---
    const BASE_URL = 'http://localhost:8080';

    // API ì—”ë“œí¬ì¸íŠ¸
    const GET_ROOMS_API = '/api/chat/rooms/get';
    const CURSOR_API_ENDPOINT = '/api/chat/rooms/read-cursor/update';

    // WebSocket ì—”ë“œí¬ì¸íŠ¸
    const WS_ENDPOINT = '/chat';
    const SEND_ENDPOINT = '/app/chat.send';
    const SUBSCRIBE_PREFIX = '/sub/chat.room.';

    // ... (ì „ì—­ ìƒíƒœ ë³€ìˆ˜, DOM ìš”ì†Œ ë³€ìˆ˜ëŠ” ë™ì¼) ...
    let stompClient = null;
    let subscription = null;
    let jwtToken = null;
    let myId = null;
    let currentRoomId = null;

    const controlsPanel = document.getElementById('controls-panel');
    const chatHeader = document.getElementById('chat-header');
    const chatInputArea = document.getElementById('chat-input-area');
    const unreadCheckPanel = document.getElementById('unread-check-panel');
    const unreadResult = document.getElementById('unread-result');

    // --- 3. API í˜¸ì¶œ í•¨ìˆ˜ ---

    /**
     * â—ï¸ 2. ìˆ˜ì •: `getRooms` APIë¥¼ POST + FormDataë¡œ í˜¸ì¶œ
     */
    async function getRoomsApi() {
        const formData = new FormData();
        formData.append('pageNumber', 0);
        formData.append('pageSize', 20);

        try {
            const response = await fetch(`${BASE_URL}${GET_ROOMS_API}`, {
                method: 'POST', // ğŸ‘ˆ GET -> POST
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                    // 'Content-Type'ì€ FormDataê°€ ìë™ìœ¼ë¡œ ì„¤ì •
                },
                body: formData // ğŸ‘ˆ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ëŒ€ì‹  bodyì— FormData ì „ì†¡
            });
            if (!response.ok) throw new Error(`ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${await response.text()}`);
            return await response.json(); // ChatRoomResponse ë°˜í™˜
        } catch (error) {
            console.error(error);
            alert(error.message);
            return null;
        }
    }

    /**
     * (ë³€ê²½ ì—†ìŒ) ì½ìŒ ì»¤ì„œ ê°±ì‹  API (ì…ì¥/í‡´ì¥)
     */
    async function callReadCursorApi(roomId, isEntered) {
        const formData = new FormData();
        formData.append('chatRoomId', roomId);
        formData.append('isEntered', isEntered);

        try {
            const response = await fetch(`${BASE_URL}${CURSOR_API_ENDPOINT}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${jwtToken}` },
                body: formData
            });
            if (response.ok) {
                console.log(`ì½ìŒ ì»¤ì„œ ê°±ì‹  ì„±ê³µ (isEntered=${isEntered})`);
            } else {
                console.error(`ì½ìŒ ì»¤ì„œ ê°±ì‹  ì‹¤íŒ¨ (isEntered=${isEntered}): ${await response.text()}`);
            }
        } catch (error) {
            console.error('ì½ìŒ ì»¤ì„œ API ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        }
    }

    // --- 4. WebSocket ì—°ê²° í•¨ìˆ˜ ---

    /**
     * (ë³€ê²½ ì—†ìŒ) WebSocket ì—°ê²° ë° êµ¬ë…
     */
    function connectWebSocket(roomId) {
        const sock = new SockJS(`${BASE_URL}${WS_ENDPOINT}`);
        stompClient = Stomp.over(sock);
        stompClient.connect(
            { Authorization: `Bearer ${jwtToken}` },
            (frame) => {
                updateStatus(true);
                const destination = `${SUBSCRIBE_PREFIX}${roomId}`;
                subscription = stompClient.subscribe(destination, (message) => {
                    const body = JSON.parse(message.body);
                    appendMessage(body);
                });
            },
            (error) => {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                updateStatus(false);
            }
        );
    }

    // --- 5. UI í—¬í¼ í•¨ìˆ˜ ---

    /**
     * â—ï¸ 1. ìˆ˜ì •: ë©”ì‹œì§€ë¥¼ ë§¨ ì•„ë˜ì— ì¶”ê°€(appendChild)í•˜ê³  ìŠ¤í¬ë¡¤
     */
    function appendMessage(messageBody) {
        const chatWindow = document.getElementById('chat-window');
        if (!myId) return;

        const isMe = messageBody.senderId === myId;
        const msgContainer = document.createElement('div');
        msgContainer.className = 'msg-container flex flex-col';

        const msgDiv = document.createElement('div');
        msgDiv.className = `msg max-w-[75%] rounded-2xl py-2 px-4 ${isMe ? 'bg-blue-500 text-white self-end' : 'bg-gray-200 text-black self-start'}`;
        msgDiv.textContent = messageBody.content;

        msgContainer.appendChild(msgDiv);

        // â—ï¸ ìˆ˜ì •: prepend -> appendChild
        chatWindow.appendChild(msgContainer);

        // â—ï¸ ì¶”ê°€: ìƒˆ ë©”ì‹œì§€ í›„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /**
     * (ë³€ê²½ ì—†ìŒ) ì—°ê²° ìƒíƒœ UI ê°±ì‹ 
     */
    function updateStatus(isConnected) {
        const pill = document.getElementById('status-pill');
        const text = document.getElementById('status-text');
        if (isConnected) {
            pill.className = 'w-3 h-3 rounded-full bg-green-500';
            text.textContent = 'ì—°ê²°ë¨';
            controlsPanel.classList.add('hidden');
            chatHeader.classList.remove('hidden');
            chatInputArea.classList.remove('hidden');
            unreadCheckPanel.classList.add('hidden');
        } else {
            pill.className = 'w-3 h-3 rounded-full bg-gray-400';
            text.textContent = 'ì—°ê²° ëŠê¹€';
            controlsPanel.classList.remove('hidden');
            chatHeader.classList.add('hidden');
            chatInputArea.classList.add('hidden');
            unreadCheckPanel.classList.remove('hidden');
        }
    }

    // --- 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

    // (ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ 'connect-btn', 'disconnect-btn', 'send-btn', 'check-unread-btn', 'message-input'ì€ ë³€ê²½ ì‚¬í•­ ì—†ìŒ)

    document.getElementById('connect-btn').onclick = async () => {
        jwtToken = document.getElementById('token').value.trim();
        myId = document.getElementById('myId').value.trim();
        const roomId = document.getElementById('chatRoomId').value.trim();

        if (!jwtToken || !myId || !roomId) {
            alert("í† í°, ë³¸ì¸ UUID, ì±„íŒ…ë°© IDë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        currentRoomId = roomId;

        await callReadCursorApi(roomId, true);
        connectWebSocket(roomId);
    };

    document.getElementById('disconnect-btn').onclick = async () => {
        if (!currentRoomId || !jwtToken) return;

        await callReadCursorApi(currentRoomId, false);

        if (subscription) subscription.unsubscribe();
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(() => {
                updateStatus(false);
                console.log("WebSocket ì—°ê²° í•´ì œë¨");
            });
        } else {
            updateStatus(false);
        }

        unreadResult.textContent = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•ˆ ì½ì€ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    };

    document.getElementById('send-btn').onclick = () => {
        const content = document.getElementById('message-input').value;
        if (!stompClient || !stompClient.connected || !content.trim()) return;

        const payload = {
            chatRoomId: currentRoomId,
            content: content,
            type: 'TEXT',
        };

        stompClient.send(SEND_ENDPOINT, {}, JSON.stringify(payload));
        document.getElementById('message-input').value = '';
    };

    document.getElementById('check-unread-btn').onclick = async () => {
        if (!jwtToken || !currentRoomId) {
            alert("í† í° ì •ë³´ê°€ ì—†ê±°ë‚˜, ì…ì¥í–ˆë˜ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        unreadResult.textContent = 'ì•ˆ ì½ì€ ë©”ì‹œì§€ ì •ë³´ ì¡°íšŒ ì¤‘...';

        const response = await getRoomsApi(); // ğŸ‘ˆ ìˆ˜ì •ëœ POST í•¨ìˆ˜ í˜¸ì¶œ
        if (!response) {
            unreadResult.textContent = 'ì •ë³´ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            return;
        }

        const roomList = response.chatRooms.content;
        const targetRoom = roomList.find(room => room.chatRoomId === currentRoomId);

        if (!targetRoom) {
            unreadResult.textContent = 'ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì´ ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        const unreadCount = targetRoom.unreadCount;
        const lastMessage = targetRoom.lastMessageContent;

        const resultText = `--- ë°©ê¸ˆ ë‚˜ê°„ ë°©(${currentRoomId.substring(0, 8)}...) ì •ë³´ ---
ì•ˆ ì½ì€ ë©”ì‹œì§€ ê°œìˆ˜: ${unreadCount}
ê°€ì¥ ìµœê·¼ ë©”ì‹œì§€: ${lastMessage}
`;
        unreadResult.textContent = resultText;
    };

    document.getElementById('message-input').addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            document.getElementById('send-btn').click();
        }
    });

</script>
</body>
</html>
