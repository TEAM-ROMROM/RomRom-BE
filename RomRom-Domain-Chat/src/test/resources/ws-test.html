<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸ v5 (History Load)</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; }
        .chat-window { display: flex; flex-direction: column; scroll-behavior: smooth; }
        .msg { word-break: break-word; white-space: pre-wrap; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen">

<div class="w-full max-w-md bg-white shadow-2xl rounded-2xl flex flex-col overflow-hidden" style="height: 85vh;">

    <div id="controls-panel" class="p-6 border-b border-gray-100 bg-white">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Chat Test Session</h2>
        <div class="space-y-3">
            <input id="token" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="JWT í† í°">
            <div class="grid grid-cols-2 gap-2">
                <input id="myId" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ë³¸ì¸ UUID">
                <input id="chatRoomId" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ë°© UUID">
            </div>
        </div>
        <button id="connect-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-6 hover:bg-blue-700 shadow-lg transition-all active:scale-95">
            ì±„íŒ…ë°© ì…ì¥ (ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°)
        </button>
    </div>

    <div id="chat-header" class="hidden p-4 border-b border-gray-100 flex justify-between items-center bg-white">
        <div class="flex items-center space-x-3">
            <div id="status-pill" class="w-3 h-3 rounded-full bg-gray-400"></div>
            <div>
                <p id="status-text" class="text-sm font-bold text-gray-700">ì—°ê²° ì¤€ë¹„ ì¤‘...</p>
                <p id="room-display-id" class="text-[10px] text-gray-400 font-mono"></p>
            </div>
        </div>
        <button id="disconnect-btn" class="text-gray-400 hover:text-red-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
        </button>
    </div>

    <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50">
        <div id="history-status" class="text-center text-gray-400 text-xs py-10 hidden">ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="chat-input-area" class="hidden p-4 bg-white border-t border-gray-100 flex items-center space-x-2">
        <input id="message-input" class="flex-1 px-4 py-2.5 bg-gray-100 border-none rounded-2xl outline-none text-sm" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button id="send-btn" class="bg-blue-600 text-white p-2.5 rounded-2xl hover:bg-blue-700 shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
        </button>
    </div>

    <div id="unread-check-panel" class="hidden p-5 bg-white border-t border-gray-100">
        <button id="check-unread-btn" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl hover:bg-emerald-600 shadow-lg">ë‚˜ê°„ ë°© ì •ë³´ í™•ì¸</button>
        <div id="unread-result-box" class="hidden mt-4 p-4 bg-gray-50 rounded-xl border border-gray-100 text-[10px] font-mono whitespace-pre"></div>
    </div>
</div>

<script>
    const HTTP_BASE_URL = 'http://localhost:8080';
    const WS_BASE_URL = 'ws://localhost:8080';

    const ENDPOINTS = {
        GET_ROOMS: '/api/chat/rooms/get',
        GET_MESSAGES: '/api/chat/rooms/messages/get', // ğŸ‘ˆ ì¶”ê°€ë¨
        UPDATE_CURSOR: '/api/chat/rooms/read-cursor/update',
        WS: '/chat',
        SEND: '/app/chat.send',
        SUB: '/sub/chat.room.'
    };

    let stompClient = null;
    let subscription = null;
    let jwtToken = null;
    let myId = null;
    let currentRoomId = null;

    const el = (id) => document.getElementById(id);
    const ui = {
        controls: el('controls-panel'),
        header: el('chat-header'),
        window: el('chat-window'),
        inputArea: el('chat-input-area'),
        unreadPanel: el('unread-check-panel'),
        resultBox: el('unread-result-box'),
        historyStatus: el('history-status')
    };

    // --- API ê³µí†µ í•¨ìˆ˜ ---
    async function fetchApi(path, body) {
        try {
            const response = await fetch(`${HTTP_BASE_URL}${path}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${jwtToken}` },
                body: body
            });
            if (!response.ok) throw new Error(`ì—ëŸ¬: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    // --- ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ---
    async function loadChatHistory(roomId) {
        ui.historyStatus.classList.remove('hidden');
        ui.historyStatus.textContent = "ê³¼ê±° ëŒ€í™” ë‚´ì—­ ë¡œë”© ì¤‘...";

        const fd = new FormData();
        fd.append('chatRoomId', roomId);

        const res = await fetchApi(ENDPOINTS.GET_MESSAGES, fd);

        if (res && res.messages) {
            // Page ê°ì²´ì´ë¯€ë¡œ res.messages.contentì— ë°ì´í„°ê°€ ìˆìŒ
            // ìµœì‹ ìˆœìœ¼ë¡œ ì˜¤ê¸° ë•Œë¬¸ì— í™”ë©´ì—ëŠ” ë°˜ëŒ€ë¡œ(ì˜¤ë˜ëœ ìˆœ) ê·¸ë ¤ì•¼ í•¨
            const history = res.messages.content.reverse();

            ui.window.innerHTML = ''; // ê¸°ì¡´ ì•ˆë‚´ ë¬¸êµ¬ ì‚­ì œ
            history.forEach(msg => {
                appendMessage(msg, true); // history í”Œë˜ê·¸ true
            });

            ui.historyStatus.textContent = "--- ì´ì „ ëŒ€í™” ë‚´ì—­ì…ë‹ˆë‹¤ ---";
        } else {
            ui.historyStatus.textContent = "ëŒ€í™” ë‚´ì—­ì´ ì—†ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        }
    }

    // --- WebSocket ì—°ê²° ---
    function connectWebSocket(roomId) {
        const socket = new WebSocket(`${WS_BASE_URL}${ENDPOINTS.WS}`);
        stompClient = Stomp.over(socket);
        stompClient.debug = (str) => console.log('[STOMP]', str);

        stompClient.connect(
            { Authorization: `Bearer ${jwtToken}` },
            (frame) => {
                setConnectedUI(true);
                el('room-display-id').textContent = roomId;
                el('status-text').textContent = "ì‹¤ì‹œê°„ ì—°ê²°ë¨";
                el('status-pill').className = "w-3 h-3 rounded-full bg-green-500";

                subscription = stompClient.subscribe(`${ENDPOINTS.SUB}${roomId}`, (msg) => {
                    const data = JSON.parse(msg.body);
                    appendMessage(data, false);
                });
            },
            (err) => {
                alert("WebSocket ì—°ê²° ì‹¤íŒ¨");
                setConnectedUI(false);
            }
        );
    }

    // --- UI í—¬í¼ ---
    function appendMessage(data, isHistory = false) {
        const isMe = data.senderId === myId;
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} ${isHistory ? 'opacity-80' : ''}`;

        // ë‚ ì§œ/ì‹œê°„ ì²˜ë¦¬ (LocalDateTime í¬ë§· ëŒ€ì‘)
        const timeStr = data.createdDate ? new Date(data.createdDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'ë°©ê¸ˆ';

        msgDiv.innerHTML = `
            <div class="max-w-[80%] px-4 py-2 rounded-2xl text-sm ${
            isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none shadow-sm'
        }">
                ${data.content}
            </div>
            <span class="text-[9px] text-gray-400 mt-1 px-1">${timeStr}</span>
        `;

        ui.window.appendChild(msgDiv);
        ui.window.scrollTop = ui.window.scrollHeight;
    }

    function setConnectedUI(connected) {
        if (connected) {
            ui.controls.classList.add('hidden');
            ui.header.classList.remove('hidden');
            ui.inputArea.classList.remove('hidden');
            ui.unreadPanel.classList.add('hidden');
        } else {
            ui.controls.classList.remove('hidden');
            ui.header.classList.add('hidden');
            ui.inputArea.classList.add('hidden');
            ui.unreadPanel.classList.remove('hidden');
        }
    }

    // --- ë²„íŠ¼ ì´ë²¤íŠ¸ ---
    el('connect-btn').onclick = async () => {
        jwtToken = el('token').value.trim();
        myId = el('myId').value.trim();
        currentRoomId = el('chatRoomId').value.trim();

        if (!jwtToken || !myId || !currentRoomId) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // 1. ì»¤ì„œ ê°±ì‹  (ì…ì¥ ì²˜ë¦¬)
        const fd = new FormData();
        fd.append('chatRoomId', currentRoomId);
        fd.append('isEntered', true);
        await fetchApi(ENDPOINTS.UPDATE_CURSOR, fd);

        // 2. ê³¼ê±° ë‚´ì—­ ë¨¼ì € ë¡œë“œ
        await loadChatHistory(currentRoomId);

        // 3. ì‹¤ì‹œê°„ ì›¹ì†Œì¼“ ì—°ê²°
        connectWebSocket(currentRoomId);
    };

    el('disconnect-btn').onclick = async () => {
        const fd = new FormData();
        fd.append('chatRoomId', currentRoomId);
        fd.append('isEntered', false);
        await fetchApi(ENDPOINTS.UPDATE_CURSOR, fd);

        if (subscription) subscription.unsubscribe();
        if (stompClient) stompClient.disconnect(() => setConnectedUI(false));
    };

    el('send-btn').onclick = () => {
        const input = el('message-input');
        if (!stompClient?.connected || !input.value.trim()) return;
        stompClient.send(ENDPOINTS.SEND, {}, JSON.stringify({
            chatRoomId: currentRoomId,
            content: input.value,
            type: 'TEXT'
        }));
        input.value = '';
    };

    el('check-unread-btn').onclick = async () => {
        ui.resultBox.classList.remove('hidden');
        const fd = new FormData();
        fd.append('pageNumber', 0);
        fd.append('pageSize', 30);
        const res = await fetchApi(ENDPOINTS.GET_ROOMS, fd);

        if (res && res.chatRoomDetailDtoPage) {
            const room = res.chatRoomDetailDtoPage.content.find(r => r.chatRoomId === currentRoomId);
            ui.resultBox.textContent = room ? JSON.stringify(room, null, 2) : "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ";
        }
    };

    el('message-input').onkeydown = (e) => { if (e.key === 'Enter') el('send-btn').click(); };
</script>
</body>
</html>